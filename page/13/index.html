<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#33363b">
    <meta name="msapplication-TileColor" content="#33363b">
    
    
    
    
    <meta name="keywords" content="leinlin, ARIA, Hexo">
    
    
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    
    
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-chrome-192x192.png">
    
    
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    
    
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    
    
    <link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#33363b">
    
    
    <link rel="manifest" href="/favicons/site.webmanifest">
    
    
    <meta name="msapplication-config" content="/favicons/browserconfig.xml">
    
    
    <link rel="alternate" href="/atom.xml" title="leinlin的小笔记" type="application/atom+xml" />
    
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicons/favicon.ico">
    
    
    <link rel="stylesheet" type="text/css" href="/css/normalize.css">
    <link rel="stylesheet" type="text/css" href="/css/index.css">
    
    <link rel="stylesheet" type="text/css" href="/css/sidebar.css">
    
    
<link rel="stylesheet" type="text/css" href="/css/page.css">
<link rel="stylesheet" type="text/css" href="/css/post.css">

    <link rel="stylesheet" type="text/css" href="/css/custom.css">
    <link rel="stylesheet" type="text/css" href="/css/atom-one-light.css">
    <link rel="stylesheet" type="text/css" href="/css/lightgallery.min.css">
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script defer type="text/javascript" src="/js/util.js"></script>
    <script defer type="text/javascript" src="/js/clipboard.min.js"></script>
    <script defer type="text/javascript" src="/js/scrollspy.js"></script>
    <script defer type="text/javascript" src="/js/fontawesome-all.min.js"></script>
    <script defer type="text/javascript" src="/js/lightgallery.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-fullscreen.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-hash.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-pager.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-thumbnail.min.js"></script>
    <script defer type="text/javascript" src="/js/lg-zoom.min.js"></script>
    
    <script defer src="/js/busuanzi.pure.mini.js"></script>
    
    
    <script defer type="text/javascript" src="/js/search.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var searchPath = "search.xml";
      if (searchPath.length === 0) {
        searchPath = "search.xml";
      }
      var path = "/" + searchPath;
      searchFunc(path, "search-input", "search-result");
    });
    </script>
    
    
    
    <script defer type="text/javascript" src="https://cdn.staticfile.org/MathJax/MathJax-2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ["script", "noscript", "style", "textarea", "pre", "code"]
      }
    });
    </script>
    <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += " has-jax";
      }
    });
    </script>
    
    
    <script defer type="text/javascript" src="/js/index.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
      var cb = null;
      var els = $(".post figure.highlight");
      if (els.length) {
        // Enabled Hexo highlight line number.
        $(els).each(function (i, e) {
          // $(e).before("<button class=\"copy button\">复制</button>");
          $(e).before([
            "<div class=\"code-titlebar\">",
              "<div class=\"titlebar-left\">",
                "<button class=\"copy\">复制</button>",
              "</div>",
            "</div>"
          ].join(""));
        });
        cb = new ClipboardJS("button.copy", {
          "target": function (trigger) {
              // Get target element by DOM API.
              return trigger.parentNode.parentNode.nextElementSibling.firstChild.firstChild.firstChild.lastChild.firstChild.firstChild;
          }
        });
      } else {
        // Disabled Hexo highlight line number.
        els = $(".post pre code");
        $(els).each(function (i, e) {
          // Add button before pre, not code.
          // $(e).parent().before("<button class=\"copy button\">复制</button>");
          $(e).before([
            "<div class=\"code-titlebar\">",
              "<div class=\"titlebar-left\">",
                "<button class=\"copy\" >复制</button>",
              "</div>",
              "<div class=\"titlebar-right\">",
                "<button class=\"button-dot dot-minimize\" aria-label=\"Decoration\"></button>",
                "<button class=\"button-dot dot-maximize\" aria-label=\"Decoration\"></button>",
                "<button class=\"button-dot dot-close\" aria-label=\"Decoration\"></button>",
              "</div>",
            "</div>"
          ].join(""));
        });
        cb = new ClipboardJS("button.copy", {
          "target": function (trigger) {
              // Get target element by DOM API.
              return trigger.parentNode.parentNode.nextElementSibling;
          }
        });
      }
      cb.on("success", function (e) {
        e.clearSelection();
        var trigger = e.trigger;
        // Change button text as a user tip.
        trigger.innerHTML = "已复制";
        $(trigger).addClass("copied");
        // Change button text back;
        setTimeout(function () {
          trigger.innerHTML = "复制";
          $(trigger).removeClass("copied");
        }, 1500);
      });
    });
    </script>
    
    <script defer type="text/javascript" src="/js/custom.js"></script>
    <title>leinlin的小笔记</title>
  <meta name="generator" content="Hexo 6.2.0"></head>
  <body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"  data-spy="scroll" data-target=".list-group">
    
<header id="header" class="header" style="background: #33363b;">
  <div class="container">
    <div class="header-container">
      <div class="header-title">
        <h1 class="title"><a href="/">leinlin的小笔记</a></h1>
        <h2 class="subtitle"></h2>
      </div>
      
    </div>
    <nav id="nav" class="nav">
      <a id="nav-toggle" class="nav-toggle" aria-hidden="true"><i class="fas fa-bars" aria-label="切换导航栏"></i></a>
      <ul id="menu" role="menubar" aria-hidden="false">
        
        <li role="menuitem"><a href="/"><i class="fas fa-home"></i><span class="menu-text">首页</span></a></li>
        
        <li role="menuitem"><a href="/categories/"><i class="fas fa-th-list"></i><span class="menu-text">分类</span></a></li>
        
      </ul>
    </nav>
  </div>
</header>


    <main id="main" class="main">
      <div class="container">
        <div class="main-container">
          <div class="content">
            

<div id="index" class="index page">
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/RTR/%E8%A1%A8%E9%9D%A2%E5%8F%8D%E5%B0%84%E6%A8%A1%E5%9E%8B/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/RTR/%E8%A1%A8%E9%9D%A2%E5%8F%8D%E5%B0%84%E6%A8%A1%E5%9E%8B/" itemprop="url">表面反射模型基础推到</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RTR/" itemprop="url" rel="index"><span itemprop="name">RTR</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="表面反射模型基础推到"><a href="#表面反射模型基础推到" class="headerlink" title="表面反射模型基础推到"></a>表面反射模型基础推到</h1><p>这篇文章主要用来推导、描述表面反射模型：包括PBR的BRDF、BSSRDF、BSDF以及风格化渲染的反射模型、二次元渲染的反射模型等等内容。</p>
<p>光线照射到物体表面，发生反射，之后反射光线进入人眼，最终形成人眼对物体的感觉。</p>
<p><strong>所以最重要的就是光线如何在不同的材质上进行反射，也就是我们现在要研究的反射模型。</strong></p>
<h2 id="BRDF"><a href="#BRDF" class="headerlink" title="BRDF"></a>BRDF</h2><p><strong>双向反射分布函数（BRDF）</strong>就是最常用的对表面反射的定义。</p>
<p>BRDF描述的问题：当沿着$w_i$方向入射辐射度为$$ L_{(p,w_i)} $$时，朝向观察者且方向为$$ w_o $$的离开当前表面的辐射度。</p>
<p>假设$ w_i $为微分方向视椎体，$$ p $$为入射点，则p处的微分入射辐射度为：</p>
<p>$$ dE(p,w_i) &#x3D; L_i(p,w_i)cos(\theta_i)dw_i $$</p>
<p>$ L_i(p,w_i) $ 单位辐射角入射光强度，$ cos(\theta_i) $法线和入射角夹角，$ dw_i $为微分方向视椎体</p>
<p>我们很容易想到，反射光线和入射光线强度是成正比的：</p>
<p>$$ dE(p,w_i) \propto dL_o(p,w_o) $$ </p>
<p>所以当给定一对如何方向和反射方向，BDRF函数可以写作：</p>
<p>$$ f_r(p,w_o,w_i) &#x3D; \frac{dL_o(p,w_o)}{dE(p,w_i)} &#x3D; \frac{dL_o(p,w_o)}{L_i(p,w_i)cos(\theta_i)dw_i} $$</p>
<p>上面是BRDF函数，而物理的BRDF函数同时还需要满足：</p>
<ul>
<li><p>互易性：$$ f_r(p,w_o,w_i) &#x3D; f_r(p,w_i,w_o) $$</p>
</li>
<li><p>能量守恒。</p>
</li>
</ul>
<p>最终的反射光为：</p>
<p>$$ L_o{(p,w_o)} &#x3D; \int_{\cal H(n)} f_r(p,w_o,w_i)L_i(p,w_i)cos(\theta_i)dw_i $$</p>
<p>上面的$$ w_o $$只局限在反射方向，就是法线方向的上半球$$ \cal H(n) $$。</p>
<h2 id="BTDF"><a href="#BTDF" class="headerlink" title="BTDF"></a>BTDF</h2><p>而表面还可能有透视光线，即穿透到法线放线下半球的光线，我们用<strong>双向透射分布函数表述（BTDF）</strong>。$$ w_o $$和$$ w_i $$分布于法线两边。</p>
<ul>
<li>BTDF不需要满足互易性：从物理意义上来说就是，透射两边的折射率不同。</li>
</ul>
<p>最终的透射光为：</p>
<p>​			$$ L_o{(p,w_o)} &#x3D; \int_{\Theta(n)} f_t(p,w_o,w_i)L_i(p,w_i)|cos(\theta_i)|dw_i $$</p>
<p>上面的$$w_o$$只局限在透射方向，就是法线方向的下半球$$ \Theta(n) $$。</p>
<h2 id="BSSRDF"><a href="#BSSRDF" class="headerlink" title="BSSRDF"></a>BSSRDF</h2><p>很多材质还会表现出<strong>下表面的光线传输</strong>。<strong>双向散射表面反射分布函数（BSSRDF）</strong>。</p>
<p>与反射分布函数和透射分布函数不同的是：<strong>散射的能量还需要考虑从其他附近入射点传递来的能量</strong>。</p>
<p>此时，$$ f_r(p,w_o,w_i) &#x3D; \frac{dL_o(p,w_o)}{dE(p,w_i)}  $$  只考虑了当前点的入射，还需要考虑附近点的积累$$ S(p_o,w_o,p_i,w_i) &#x3D; \frac{dL_o(p_o,w_o)}{dE(p_i,w_i)}  $$。</p>
<p>也就是说，在附近某一点$ p_i $ 处入射的能量与他最终离开$ p_o $点时能量的比例就是$$ S(p_o,w_o,p_i,w_i) $$。</p>
<p>所以这个时候的积分需要考虑的不再是一个点，还需要考虑一片区域：</p>
<p>​			$$  L_o{(p_o,w_o)} &#x3D; \int_A  \int_{\Theta(n)} S(p_o,w_o,p_i,w_i) L_i(p_i,w_i)|cos(\theta_i)|dw_i dA $$</p>
<p>这个公式有如下特点：</p>
<ul>
<li>随着$p_o$和$ p_i$的距离增加S的值会变小</li>
<li>通常算法会通过一个卷积（基于几何空间或者基于图片空间）来表述，周围表面受光对当前点的影响。</li>
</ul>
<h1 id="辐射度理论"><a href="#辐射度理论" class="headerlink" title="辐射度理论"></a>辐射度理论</h1><p>为什么将辐射度理论，<strong>就是为了更好的理解光线的发射与吸收的多少。</strong></p>
<p>辐射通量（$$ \Phi $$，也叫作功率）：单位时间内，穿过某一表面或空间的全部能量。</p>
<p>辐射度（$$ W&#x2F;m^2 $$）：表示穿过某一表面的<strong>通量面密度</strong>（可以理解成穿过单位面积的光线数量，<strong>可以理解亮度、光照强度</strong>）。</p>
<p>一个点光源发射光线，在具体他为r的位置，出辐射度为：</p>
<p>$$ E &#x3D; \Phi &#x2F; 4\pi r^2 $$</p>
<p>所以<strong>光照强度</strong>（就是单位面积光线数量，也就是<strong>通量面密度</strong>）按照距离的平方进行衰减的。</p>
<h2 id="Lambertian定理"><a href="#Lambertian定理" class="headerlink" title="Lambertian定理"></a>Lambertian定理</h2><h3 id="入射辐射度"><a href="#入射辐射度" class="headerlink" title="入射辐射度"></a>入射辐射度</h3><p><strong>Lambertian定理：到达表面的光线数量正比与光线方向和法线方向夹角的余弦。</strong></p>
<p>如下图，一个<strong>面光源</strong>以$\theta$角度照射表面，面光源面积为$ A $,辐射通量为$ \Phi $，对应接受光照的表面面积为$ A1 $。<strong>如果A足够的小</strong>（这一点非常重要），那么对于A1内的点，入辐射度<strong>约</strong>为 $$ E &#x3D; \frac{\Phi\cos(\theta)}{A} $$ 。</p>
<p><img src="/../../images/img/brdf_inlight.jpg" alt="brdf_inlight"></p>
<h3 id="出射辐射度"><a href="#出射辐射度" class="headerlink" title="出射辐射度"></a>出射辐射度</h3><p><strong>Lambertian反射</strong>：反射方向的单位<strong>辐射度</strong>均匀分布&#x3D; $$ \frac{接收的光线强度}{\pi} $$ </p>
<p>如下图，假如A处的<strong>光线是按照各个方向平均反射</strong>的，那么A1和A2接收到的<strong>光线总数</strong>是一样多的。但是，由于A1和A2的<strong>面积不一样</strong>，所以他们的<strong>辐射度</strong>（<strong>光照强度</strong>，<strong>亮度</strong>）是不一样的！！！</p>
<p><strong>而Lambertian反射要求的是辐射度一样</strong>，<strong>所以光线的反射数量与反射方向和法线方向夹角的余弦成正比。</strong></p>
<p><img src="/../../images/img/brdf_outlight.jpg" alt="brdf_outlight"></p>
<h1 id="表面反射函数实践"><a href="#表面反射函数实践" class="headerlink" title="表面反射函数实践"></a>表面反射函数实践</h1><p>首先BDRF的积分可以简化为求和，因为游戏引擎中光照都是通过有限个光源计算的，不在需要<strong>微分方向视椎体</strong>：</p>
<p>$$ L_o{(p,w_o)} &#x3D; \int_{\cal H(n)} f_r(p,w_o,w_i)L_i(p,w_i)cos(\theta_i)dw_i $$</p>
<p>变成：</p>
<p>$$ L_o{(p,w_o)} &#x3D; \sum_{w_i} f_r(p,w_o,w_i)L_i(p,w_i)cos(\theta_i) $$</p>
<p>$$ w_i $$ :为某个入射光方向。</p>
<p>$$ L_i(p,w_i) $$  :  一般就是经过<strong>距离衰减</strong>和<strong>阴影遮挡</strong>计算之后的光亮度。</p>
<p>$$ cos(\theta_i) $$ 	: 就是$$ dot(w_i,w_o) $$</p>
<p>另一点需要注意的是，RGB通道的每个分量的颜色都是独立计算的。</p>
<p>下面我们将讨论具体的$$  f_r(p,w_o,w_i) $$都是怎么计算的。</p>
<h2 id="Lambertian反射"><a href="#Lambertian反射" class="headerlink" title="Lambertian反射"></a>Lambertian反射</h2><p>Lambertian模型可以作为最简单的BRDF模型，他是能量守恒的。</p>
<p>$$ f_{Lambertian}(p,w_o,w_i) &#x3D; \frac{R}{\pi} $$</p>
<p>$$ R $$  :表示的是表面反射率（Albedo\Diffuse），在实际中就是RGB通道的颜色值。</p>
<h3 id="Lambertian为什么除-pi"><a href="#Lambertian为什么除-pi" class="headerlink" title="Lambertian为什么除$ \pi $"></a>Lambertian为什么除$ \pi $</h3><p>首先分析一种错误的理解：反射半球的表面积应该是$$ 2\pi r^2 $$，反射射光照总能量比例为$$R$$，各个方向平均反射，所以最终lambertian反射强度应该是:</p>
<p>$$ \frac{R}{2\pi} $$</p>
<p>这种理解错误的原因是：Lambertian考虑的是反射辐通量（光照强度）各个方向恒定，而不是反射总辐通量R被平均分。</p>
<p>那么这个$$ \frac{R}{\pi} $$是怎么来的？</p>
<p>对<strong>幅通量</strong>根据Lambertian定律（反射幅通量和$ cos(\theta) $成正比）进行半球积分得到表面接收的<strong>辐通量</strong>。</p>
<p><img src="/../../images/img/Lamberts-cosine-law.png" alt="Lamberts-cosine-law"></p>
<p>对所有方向的辐通量进行积分就可以得到反射全部的总辐射度：</p>
<p>$$ L_o&#x3D; \int  f_{Lambertian}(p,w_o,w_i) cos\theta dw_o $$	</p>
<p><strong>有一个需要理解的地方：因某个方向的出辐射度为X（面积小），那么对其贡献辐射度的表面上的辐射度为$Xcos\theta$（面积大所以贡献的辐射度少）。</strong></p>
<p>因为，Lambertian的brdf($$ f_{Lambertian}(p,w_o,w_i) $$ )是常数：</p>
<p>$$ L_o&#x3D; \int  f_{Lambertian}(p,w_o,w_i)  cos\theta dw_o $$	</p>
<p>进行移项：</p>
<p>$$ \frac{L_o}{f_{Lambertian}(p,w_o,w_i) } &#x3D; \int cos \theta dw_o $$</p>
<p>下面对：反射半球半球积分$$ \int cos \theta dw_o $$ 进行拆解和仔细计算：</p>
<p>$$ \int_0^{2\pi} \int_0^{\frac{\pi}{2} } cos \theta \ sin \theta d \theta d \phi   $$</p>
<p>$$ &#x3D; 4  \int_0^{\frac{\pi}{2}}  \int_0^{\frac{\pi}{2} }  cos \theta  sin\theta d \theta d \phi $$</p>
<p>$$ &#x3D;   \int_0^{\frac{\pi}{2}}  \int_0^{\frac{\pi}{2} }  sin 2\theta d 2\theta d \phi $$</p>
<p>$$ &#x3D; \int_0^{\frac{\pi}{2}}  \int_0^{\frac{\pi}{2} }  d(-cos 2\theta  )d \phi $$</p>
<p>$$ &#x3D;(-cos \pi + cos 0) *\frac{\pi}{2} $$</p>
<p>$$ &#x3D;\pi $$</p>
<p>所以：</p>
<p>$$ \frac{L_o}{f_{Lambertian}(p,w_o,w_i)} &#x3D; \pi $$</p>
<p>$$f_{Lambertian}(p,w_o,w_i)  &#x3D;  \frac{L_o}{ \pi} $$</p>
<p>假设入射辐通量为1，表面反射率为R（入射光被反射的比例），则反射辐通量（反射之后分布到各个方向后的比例）为：</p>
<p>$$f_{Lambertian}(p,w_o,w_i) &#x3D;  \frac{R}{ \pi} $$</p>
<p>至此，推导完毕。</p>
<h2 id="菲涅尔方程"><a href="#菲涅尔方程" class="headerlink" title="菲涅尔方程"></a>菲涅尔方程</h2><p>菲涅尔等式主要用来求解反射和透射系数。</p>
<p>首先需要，两种材质的折射率$$ \eta_i $$和$$ \eta_t $$ ,一般情况下随着光的波长折射率会有变化。</p>
<p>菲涅尔定律：</p>
<p>$$ \eta_i \sin(\theta_i) &#x3D; \eta_t \sin(\theta_t) $$</p>
<p>反射定律：</p>
<p>$$\theta_i &#x3D; \theta_o$$</p>
<h3 id="Unity-Fresnel"><a href="#Unity-Fresnel" class="headerlink" title="Unity Fresnel"></a>Unity Fresnel</h3><figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">real3 <span class="hljs-title function_">F_Schlick</span><span class="hljs-params">(real3 f0, real f90, real u)</span><br>&#123;<br>    real x = <span class="hljs-number">1.0</span> - u;<br>    real x2 = x * x;<br>    real x5 = x * x2 * x2;<br>    <span class="hljs-keyword">return</span> f0 * (<span class="hljs-number">1.0</span> - x5) + (f90 * x5);        <span class="hljs-comment">// sub mul mul mul sub mul mad*3</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="微表面模型-TODO"><a href="#微表面模型-TODO" class="headerlink" title="微表面模型 TODO"></a>微表面模型 TODO</h2><p>整体BRDF模型：</p>
<p>$$f &#x3D; \frac{D()G()F()}{4cos\theta_o cos\theta_i}$$</p>
<p>下面描述整体推到过程:</p>
<h3 id="通量-Phi"><a href="#通量-Phi" class="headerlink" title="通量$ \Phi $"></a>通量$ \Phi $</h3><p>第一个概念是通量，单位时间穿过一个表面上光线的<strong>总量</strong>。（也就是功率）。</p>
<h3 id="入射辐射度-L-i-和反射辐射度-L-o"><a href="#入射辐射度-L-i-和反射辐射度-L-o" class="headerlink" title="入射辐射度$ L_i $和反射辐射度$ L_o $"></a>入射辐射度$ L_i $和反射辐射度$ L_o $</h3><p>表示<strong>单位时间单位面积</strong>入射（反射）表面接受（反射）的光线量。</p>
<p>如果入射表面面积为$$ A $$， 则：$$ L_i &#x3D; \frac{\Phi}{A} $$</p>
<p>写成微分形式：$$ L_i &#x3D; \frac{d \Phi}{d A} $$</p>
<h3 id="立体角-w-和光强"><a href="#立体角-w-和光强" class="headerlink" title="立体角$ w $和光强"></a>立体角$ w $和光强</h3><p>光线传过单位立体角的数量。就是光强。$$ E &#x3D; \frac{\Phi}{w} $$微分形式：$$ E &#x3D; \frac{d \Phi}{d w} $$</p>
<h3 id="辐射度-L"><a href="#辐射度-L" class="headerlink" title="辐射度$ L $"></a>辐射度$ L $</h3><p>单位时间内传过单位立体角单位面积的光线量。</p>
<p>$$ L &#x3D;\frac{d\Phi }{dw dA_{w} } $$         </p>
<p>$$ d\Phi_i&#x3D;  L(w_i)dw_i cos \theta_i dA $$ </p>
<p>$$ d\Phi_o&#x3D;  L(w_o)dw_o cos \theta_o dA $$ </p>
<h3 id="菲涅尔公式F"><a href="#菲涅尔公式F" class="headerlink" title="菲涅尔公式F"></a>菲涅尔公式F</h3><p>表示某一角度下光线被反射、折射的比例。 $$ \Phi_i $$为入射通量，$$ \Phi_o $$反射通量。则：</p>
<p>$$ \Phi_o &#x3D; F\Phi_i $$</p>
<h3 id="BDRF公式"><a href="#BDRF公式" class="headerlink" title="BDRF公式"></a>BDRF公式</h3><p>​				$$ f_r(p,w_o,w_i) &#x3D; \frac{L_o(p,w_o)}{dE(p,w_i)} &#x3D; \frac{L_o(p,w_o)}{L_i(p,w_i)cos(\theta_i)dw_i} $$</p>
<p>这里的$ L_o $ 没有积分符号，是因为我们现在计算的是某一条线如何光线与某一条反射光线。</p>
<h3 id="BDRF推导"><a href="#BDRF推导" class="headerlink" title="BDRF推导"></a>BDRF推导</h3><p>在微面元理论中，我们的$ dA $由很多微面元组成，并且这些面元只有<strong>全镜面反射</strong>，只有满足$$ w_h &#x3D; w_n $$的表面才能被反射出去。我们<strong>用统计模型$$D(w_h) $$来描述某个角度的面片比例</strong>。 那么入射的辐通量就需要考虑面片分布。则：</p>
<p>$$ d\Phi_i&#x3D;  L(w_i)dw_i D(w_h) dw_hcos \theta_o dA $$ </p>
<p>半角向量和出射角向量微分的对应关系:</p>
<p>$$dw_h &#x3D; \frac{dw_o}{4cos(\theta_o)}$$</p>
<p><strong>1. 菲涅尔公式+BRDF公式：</strong></p>
<p>$$ L(w_o)dw_o cos \theta_o dA &#x3D;  F L(w_i)dw_i D(w_h) dw_hcos \theta_o dA $$</p>
<p><strong>2. 半角向量和出射角向量微分的对应关系:</strong></p>
<p>$$ 4 cos \theta_o L(w_o) cos \theta_o &#x3D;  F L(w_i)dw_i D(w_h)cos \theta_h $$</p>
<p><strong>3. 通过移项、约分构造brdf</strong></p>
<p>$$ \frac{L_o(p,w_o)}{L_i(p,w_i)cos(\theta_i)dw_i}  &#x3D; \frac{ F D(w_h)  }{4  cos \theta_o cos \theta_i} $$</p>
<p><strong>4.除了上面的F、D之外，由于几何结构，还有一些光线由于几何结构被：masking 和 shadowing。所以这个比例为G项。</strong></p>
<p><strong>5.所以最终结果为：</strong></p>
<p>$$ brdf &#x3D;  \frac{L_o(p,w_o)}{L_i(p,w_i)cos(\theta_i)dw_i}  &#x3D; \frac{ F D(w_h)  G}{4  cos \theta_o cos \theta_i} $$</p>
<h3 id="法线分布函数：normal-distribution-function"><a href="#法线分布函数：normal-distribution-function" class="headerlink" title="法线分布函数：normal distribution function"></a>法线分布函数：normal distribution function</h3><p>D项：法线分布函数用来描述，法线方向在表面上的分布情况，积分结果为1。</p>
<h3 id="几何衰减：Evaluate-shadowing-x2F-masking-term"><a href="#几何衰减：Evaluate-shadowing-x2F-masking-term" class="headerlink" title="几何衰减：Evaluate shadowing&#x2F;masking term"></a>几何衰减：Evaluate shadowing&#x2F;masking <strong>term</strong></h3><p>G项：用来描述Shadow和masking项。用来描述不同的几何结构有多少光线被遮挡。</p>
<h3 id="菲涅尔项：Fresnel"><a href="#菲涅尔项：Fresnel" class="headerlink" title="菲涅尔项：Fresnel"></a>菲涅尔项：Fresnel</h3><p>F项：用来描述在不同材质，不同角度上，反射光线所占的比例。</p>
<h2 id="unity中的实现"><a href="#unity中的实现" class="headerlink" title="unity中的实现"></a>unity中的实现</h2><h3 id="Unity-Specular-Term"><a href="#Unity-Specular-Term" class="headerlink" title="Unity Specular Term"></a>Unity Specular Term</h3><figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> <span class="hljs-number">0</span>: specularTerm = ComputeWard(H, LdotH, NdotL, NdotV, positionWS, preLightData, bsdfData); <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: specularTerm = ComputeBlinnPhong(H, LdotH, NdotL, NdotV, positionWS, preLightData, bsdfData); <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: specularTerm = ComputeCookTorrance(H, LdotH, NdotL, NdotV, positionWS, preLightData, bsdfData); <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: specularTerm = ComputeGGX(H, LdotH, NdotL, NdotV, positionWS, preLightData, bsdfData); <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: specularTerm = ComputePhong(H, LdotH, NdotL, NdotV, positionWS, preLightData, bsdfData); <span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure>

<h3 id="Unity-Specular-Term-1"><a href="#Unity-Specular-Term-1" class="headerlink" title="Unity Specular Term"></a>Unity Specular Term</h3><figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">Lambert<br>OrenNayar<br></code></pre></td></tr></table></figure>


      
      <p align="right"><a class="morebtn" href="/2022/07/09/RTR/%E8%A1%A8%E9%9D%A2%E5%8F%8D%E5%B0%84%E6%A8%A1%E5%9E%8B/" title="表面反射模型基础推到">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/RTR/%E9%87%8D%E8%A6%81%E5%BA%A6%E9%87%87%E6%A0%B7/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/RTR/%E9%87%8D%E8%A6%81%E5%BA%A6%E9%87%87%E6%A0%B7/" itemprop="url">重要度采样</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RTR/" itemprop="url" rel="index"><span itemprop="name">RTR</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="重要度采样"><a href="#重要度采样" class="headerlink" title="重要度采样"></a>重要度采样</h1><p>wiki解释：<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%87%8D%E8%A6%81%E6%80%A7%E9%87%87%E6%A0%B7">重要度采样</a></p>
<p>主要：该方法从与原分布不同的另一个分布中采样，而对原先分布的性质进行估计</p>
<h2 id="重要度采样的推导"><a href="#重要度采样的推导" class="headerlink" title="重要度采样的推导"></a>重要度采样的推导</h2><p>首先利用**一个随机变量$$X$$**的多个样本值$${x_i}$$，构造期望值估计：</p>
<p>$$ \hat E[X,P] &#x3D; \frac{1}{n} \sum_{i&#x3D;1}^n  x_i $$</p>
<p>$$ X $$:随机变量</p>
<p>$$ x_i $$：$$X $$ 样本值。</p>
<p>$$P$$:  $$X$$的分布。</p>
<p>这个期望的<strong>精确度和$$X$$的方差</strong>有关：</p>
<p>$$var [\hat E ; P] &#x3D; var [X;P]&#x2F;n $$</p>
<p>为了降低方差，我们引入一个新的随机变量$$ L $$，保证$$ E[L;P]&#x3D;1$$得到：</p>
<p>$$\hat E [X; P] &#x3D; \hat E [\frac{X}{L} ; P^{(L)}] $$</p>
<p>$$L$$的作用就是降低对$$X$$的方差，来达到降低$$\hat E$$的误差的目的。</p>
<p>最优的$$ L $$为 $$ L^* &#x3D; \frac{X}{E[X;P]}$$,也就是说，$$L$$把$$X$$变成了一个常量。</p>
<p>此时，要求的期望值变为：</p>
<p> $$E[X;P] &#x3D; \frac{X}{ L^*}$$</p>
<p>但是理论上无法求得$$L*$$，所以需要进行估计，在很小的一段区间($$[a; a + da]$$)上$$L^*$$的概率为:</p>
<p>$$P^{(L^*)}(X \in [a; a+ da]) &#x3D; \int_{w \in { X \in a;a+da } } \frac{X_w}{E[x;P]} dP(w)  $$</p>
<p>实际过程我们无法的到最优化的 $$ L* $$，可以用如下方式逼近</p>
<p>$$ &#x3D;  \frac{1}{E[X;P]} aP(X \in [a; a+ da]) $$ </p>
<p>上式的意思是一段区间里面$$L^*$$的积分值。</p>
<p>由于$$L^*$$的期望等于1：</p>
<p>$$1  &#x3D; \int_{a &#x3D; -\infty}^{\infty}  \frac{1}{E[X;P]} aP(X \in [a; a+ da]) $$ </p>
<p>此时期望变为：</p>
<p> $$E[X;P]  &#x3D; \int_{a &#x3D; -\infty}^{\infty} aP(X \in [a; a+ da]) $$  </p>

      
      <p align="right"><a class="morebtn" href="/2022/07/09/RTR/%E9%87%8D%E8%A6%81%E5%BA%A6%E9%87%87%E6%A0%B7/" title="重要度采样">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/2.ShaderPass%E8%AF%B4%E6%98%8E/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/2.ShaderPass%E8%AF%B4%E6%98%8E/" itemprop="url">HDRP ShaderPass说明</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="HDRP-ShaderPass说明"><a href="#HDRP-ShaderPass说明" class="headerlink" title="HDRP ShaderPass说明"></a>HDRP ShaderPass说明</h1><h2 id="所有PassName"><a href="#所有PassName" class="headerlink" title="所有PassName"></a>所有PassName</h2><figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HDShaderPassNames</span><br>&#123;<br>  <span class="hljs-comment">// ShaderPass string - use to have consistent name through the code</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_EmptyStr = <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_ForwardStr = <span class="hljs-string">&quot;Forward&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_DepthOnlyStr = <span class="hljs-string">&quot;DepthOnly&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_DepthForwardOnlyStr = <span class="hljs-string">&quot;DepthForwardOnly&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_ForwardOnlyStr = <span class="hljs-string">&quot;ForwardOnly&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_GBufferStr = <span class="hljs-string">&quot;GBuffer&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_GBufferWithPrepassStr = <span class="hljs-string">&quot;GBufferWithPrepass&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_SRPDefaultUnlitStr = <span class="hljs-string">&quot;SRPDefaultUnlit&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_MotionVectorsStr = <span class="hljs-string">&quot;MotionVectors&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_DistortionVectorsStr = <span class="hljs-string">&quot;DistortionVectors&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_TransparentDepthPrepassStr = <span class="hljs-string">&quot;TransparentDepthPrepass&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_TransparentBackfaceStr = <span class="hljs-string">&quot;TransparentBackface&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_TransparentDepthPostpassStr = <span class="hljs-string">&quot;TransparentDepthPostpass&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_MetaStr = <span class="hljs-string">&quot;Meta&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_ShadowCasterStr = <span class="hljs-string">&quot;ShadowCaster&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> s_MeshDecalsStr = <span class="hljs-string">&quot;DBufferMesh&quot;</span>;<br><br>  <span class="hljs-comment">// ShaderPass name</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_EmptyName = <span class="hljs-keyword">new</span> ShaderPassName(s_EmptyStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_ForwardName = <span class="hljs-keyword">new</span> ShaderPassName(s_ForwardStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_DepthOnlyName = <span class="hljs-keyword">new</span> ShaderPassName(s_DepthOnlyStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_DepthForwardOnlyName = <span class="hljs-keyword">new</span> ShaderPassName(s_DepthForwardOnlyStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_ForwardOnlyName = <span class="hljs-keyword">new</span> ShaderPassName(s_ForwardOnlyStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_GBufferName = <span class="hljs-keyword">new</span> ShaderPassName(s_GBufferStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_GBufferWithPrepassName = <span class="hljs-keyword">new</span> ShaderPassName(s_GBufferWithPrepassStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_SRPDefaultUnlitName = <span class="hljs-keyword">new</span> ShaderPassName(s_SRPDefaultUnlitStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_MotionVectorsName = <span class="hljs-keyword">new</span> ShaderPassName(s_MotionVectorsStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_DistortionVectorsName = <span class="hljs-keyword">new</span> ShaderPassName(s_DistortionVectorsStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_TransparentDepthPrepassName = <span class="hljs-keyword">new</span> ShaderPassName(s_TransparentDepthPrepassStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_TransparentBackfaceName = <span class="hljs-keyword">new</span> ShaderPassName(s_TransparentBackfaceStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_TransparentDepthPostpassName = <span class="hljs-keyword">new</span> ShaderPassName(s_TransparentDepthPostpassStr);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_MeshDecalsName = <span class="hljs-keyword">new</span> ShaderPassName(s_MeshDecalsStr);<br><br>  <span class="hljs-comment">// Legacy name 这部分的Pass都会作为ErrorPass渲染</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_AlwaysName = <span class="hljs-keyword">new</span> ShaderPassName(<span class="hljs-string">&quot;Always&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_ForwardBaseName = <span class="hljs-keyword">new</span> ShaderPassName(<span class="hljs-string">&quot;ForwardBase&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_DeferredName = <span class="hljs-keyword">new</span> ShaderPassName(<span class="hljs-string">&quot;Deferred&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_PrepassBaseName = <span class="hljs-keyword">new</span> ShaderPassName(<span class="hljs-string">&quot;PrepassBase&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_VertexName = <span class="hljs-keyword">new</span> ShaderPassName(<span class="hljs-string">&quot;Vertex&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_VertexLMRGBMName = <span class="hljs-keyword">new</span> ShaderPassName(<span class="hljs-string">&quot;VertexLMRGBM&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> ShaderPassName s_VertexLMName = <span class="hljs-keyword">new</span> ShaderPassName(<span class="hljs-string">&quot;VertexLM&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="Forward"><a href="#Forward" class="headerlink" title="Forward"></a>Forward</h2><p>所有在前向渲染物体使用这个Pass，正常情况下使用Deferred时，所有不透明物体都需要在DeferredPass 完成渲染，这里只渲染透明物体。</p>
<h2 id="ForwardOnly"><a href="#ForwardOnly" class="headerlink" title="ForwardOnly"></a>ForwardOnly</h2><p>通过ForwardOnly可以强制在Forward 阶段渲染不透明物体</p>
<p>无光照物体使用这个Pass，并且不输出法线</p>
<h2 id="DepthForwardOnly"><a href="#DepthForwardOnly" class="headerlink" title="DepthForwardOnly"></a>DepthForwardOnly</h2><p>和ForwardOnly对应使用</p>
<h2 id="DepthOnly"><a href="#DepthOnly" class="headerlink" title="DepthOnly"></a>DepthOnly</h2><p>渲染深度，Forward和Deferred必须有一个深度	</p>
<h2 id="TransparentDepthPrepass"><a href="#TransparentDepthPrepass" class="headerlink" title="TransparentDepthPrepass"></a>TransparentDepthPrepass</h2><p>透明物体Prepass深度</p>

      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/2.ShaderPass%E8%AF%B4%E6%98%8E/" title="HDRP ShaderPass说明">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/10.Lighting%E8%AE%BE%E7%BD%AE/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/10.Lighting%E8%AE%BE%E7%BD%AE/" itemprop="url">光照设置</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="光照设置"><a href="#光照设置" class="headerlink" title="光照设置"></a>光照设置</h1><p>这里主要讲解GI的设置方式。</p>
<p>同时解释一下Shader是如何在<strong>光照探针</strong>、<strong>静态光照贴图</strong>，<strong>动态光照贴图</strong>，<strong>直接光照</strong>之间产生作用的。</p>
<p>首先看一下我们能设置的选项：</p>
<p>对于光源：</p>
<ol>
<li>realtime.</li>
<li>mix.</li>
<li>bake.</li>
</ol>
<p>对于emission（HDRP）：</p>
<ol>
<li>realtime.</li>
<li>bake.</li>
</ol>
<p>对于物体：</p>
<ol>
<li>lightmap static.</li>
<li>lightprobe.</li>
</ol>
<p>对于工程选项，在Windows&#x2F;Rendering&#x2F;Lighting Setting中的设置三部分：</p>
<ol>
<li>Realtime Lighting.</li>
<li>Mixed Lighting.</li>
<li>Lightmapping Setting.</li>
</ol>
<p>##测试场景</p>
<p>下面是测试场景：</p>
<p><img src="/../../images/10.%E5%85%89%E6%BA%90%E9%85%8D%E7%BD%AE.PNG" alt="光源配置"></p>
<p>测试场景当中有三个光源：红色点光源，绿色物体自发光，蓝色点光源，同时场景当中布满了光照探针。两个黑色模型，用于观察受光表现。（目前全部都是realtime光源，同时，物体是Lightmap static, realtime GI 和baked GI全部开启）。</p>
<p>从反面可以看到，红框内部就是间接光照。</p>
<p><img src="/../../images/10.%E5%85%89%E6%BA%90%E9%85%8D%E7%BD%AE%E5%8F%8D%E9%9D%A2.PNG" alt="光源配置"></p>
<p>接下来的内容会不断修改光源类型，物体类型设置和光照设置，来观察GI情况。</p>
<h2 id="光源类型"><a href="#光源类型" class="headerlink" title="光源类型"></a>光源类型</h2><p>光源有三种类型：realtime、mix、bake，如下图：</p>
<p><img src="/../../images/10.%E5%85%89%E6%BA%90%E7%B1%BB%E5%9E%8B.png"></p>
<p>每种类型的光都可以假设成由两部分组成：</p>
<p><strong>直接光照</strong>（直接照在某个物体上）</p>
<p><strong>间接光照</strong>。（经过物体反弹之后照在其他物体上）</p>
<h2 id="自发光"><a href="#自发光" class="headerlink" title="自发光"></a>自发光</h2><p>自发光也是一种光源：但是只有两种：realtime和bake。</p>
<p>这里有不同：</p>
<p>1.realtime：对应的是realtime类型光源的间接成分。</p>
<p>2.bake：对应的是bake类型的光源。</p>
<p><img src="/../../images/10.%E8%87%AA%E5%8F%91%E5%85%89%E7%B1%BB%E5%9E%8B.png"></p>
<h2 id="物体受光"><a href="#物体受光" class="headerlink" title="物体受光"></a>物体受光</h2><p>物体上和受光相关的有两个设置：</p>
<ol>
<li>lightmap static是否打开。</li>
<li>lightprobe 是否打开。</li>
</ol>
<p>选项位置见下图：</p>
<p><img src="/../../images/10.%E7%89%A9%E4%BD%93%E5%85%89%E7%85%A7%E7%B1%BB%E5%9E%8B.png"></p>
<p>下面讨论每个情况。</p>
<p>###LightMap Static物体</p>
<p>​	LightMap Static打开时受光来源：Realtime GI贴图 + Baked GI贴图 + realtime 光的直接光照 + mix 光的直接光照。(贴图内容和探针内容在后面解释)</p>
<p>当前场景两个物体都是lightMap Static。我们把测试场景中蓝色光改成bake，这个时候两个lightmap static物体的光照贴图如下。</p>
<p><img src="/../../images/10.%E7%89%A9%E4%BD%93%E5%8F%97%E5%85%89%E6%83%85%E5%86%B5.png"></p>
<p>​	从上图可以看到，蓝色光源被bake到baked lightmap中，realtime光源和realtime自发光被bake到realtimeGI当中。同时，下图是物体背面的受光情况，可以看到，间接光都存在。</p>
<p><img src="/../../images/10.%E7%89%A9%E4%BD%93%E5%8F%97%E5%85%89%E6%83%85%E5%86%B5%E8%83%8C%E9%9D%A2.PNG"></p>
<p>接下来我们在做一个实验，在运行模式下修改三个光源的颜色，</p>
<p>​	红色realtime点光源-&gt;蓝色realtime点光源， 绿色realtime自发光-&gt;黄色realtime自发光， 蓝色baked点光源-&gt;红色baked自发光</p>
<p>下图为修改后的结果，可以发现。两个点光源的变化是合理的。但是realtime GI贴图上的realtime自发光并没有变化（就是说在Play模式下并不是realtime的）。同时我发现，在编辑模式下，我修改自发光颜色realtimeGI贴图不用重新烘焙就会马上变（就是说在Editor模式下是realtime的），这个可能是bug。</p>
<p><img src="/../../images/10.%E4%BF%AE%E6%94%B9%E5%85%89%E6%BA%90%E9%A2%9C%E8%89%B2.PNG"></p>
<p>###Lightprobe物体</p>
<p>打开时受光来源： realtime光的直接光照 + mix光的直接光照 + 光照探针。</p>
<p>​	我们把下方平面取消掉lightmap static，这样这个物体就会使用LightProbe作为间接光。同时保持左侧为realtime红色光，右侧为bake蓝色光，中间为realtime自发光。</p>
<p><img src="/../../images/10.LightProbe%E7%BB%93%E6%9E%9C.PNG"></p>
<p>​	从上图可以看到，光照探针烘焙了所有的间接光（红绿蓝）。同时下方平面不再接受GI贴图，而间接光是通过光照探针插值来的（有个很重要的地方是：realtime的自发光和baked点光源表现居然是一样的的效果），选择平面后可以看到插值用到的光照探针。可以看到光照效果很差，所以大物体不适合使用探针。</p>
<p>###特殊说明</p>
<ol>
<li>如果为一个物体烘焙了光照贴图，那么即使取消了lightmap static，lightprobe也不会生效（灰色状态），必须手动清除光照贴图。</li>
</ol>
<p><img src="/../../images/10.%E9%94%99%E8%AF%AF%E5%85%89%E7%85%A7%E7%8A%B6%E6%80%811.PNG"></p>
<ol start="2">
<li>如果一个物体还没有烘焙光照贴图，那么即使LightMap Static打开，Lightprobe也可以打开（正常情况他们是互斥的）。</li>
</ol>
<p><img src="/../../images/10.%E9%94%99%E8%AF%AF%E5%85%89%E7%85%A7%E7%8A%B6%E6%80%812.PNG"></p>
<p>上面两种情况就是光照信息错误的状态。</p>
<p>物体受光可以参考一下Shader当中的逻辑：</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">float3 <span class="hljs-title function_">SampleBakedGI</span><span class="hljs-params">(float3 positionRWS, float3 normalWS, float2 uvStaticLightmap, float2 uvDynamicLightmap)</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(LIGHTMAP_ON) &amp;&amp; !defined(DYNAMICLIGHTMAP_ON)</span><br>	<span class="hljs-comment">// If there is no lightmap, it assume lightprobe</span><br>  	...<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><br>    float3 bakeDiffuseLighting = float3(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>);<br><br>    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> LIGHTMAP_ON</span><br>        bakeDiffuseLighting += SampleDirectionalLightmap();<br>    <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> DYNAMICLIGHTMAP_ON</span><br>        bakeDiffuseLighting += SampleSingleLightmap()<br>    <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-keyword">return</span> bakeDiffuseLighting;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="光源烘焙"><a href="#光源烘焙" class="headerlink" title="光源烘焙"></a>光源烘焙</h2><p>三种光源（每种光源的两个部分）和两种emission通过光照烘焙之后会通过不同的方式对物体产生影响。</p>
<ol>
<li>Realtime GI贴图： Realtime Light的间接部分  + realtime emission。</li>
<li>Baked GI贴图：Mix Light的间接部分 + Baked Light的全部 + baked emission。</li>
<li>实时光照计算： Realtime的直接部分 + MixLight的直接部分。</li>
<li>光头照探针里面：Mix Light的间接部分 + Baked Light的全部 + baked emission+ Realtime Light的间接部分</li>
</ol>
<p>这里特殊说明mix 光源类型我们关掉自发光，将红光变成mix点光源，蓝光还是bake。</p>
<p><img src="/../../images/10.mix%E5%85%89%E6%BA%90.PNG"></p>
<p>此时法线，realtime的间接光烘焙到了bakelightmap当中。此时如果在Play模式下变化mix点光源，只有直接光会变化，而Baked lilghtmap不会变化，如果在运行过程中，把红色点光源变化realtime，则Realtime lightmap中也不计算间接光，因为没有预先烘焙的信息。</p>
<p>​	<strong>结合上一部分的特殊说明：所有GI内容和物体类型，必须在设置好之后统一bake一次。在修改了物体类型和光照类型之后，也必须重新bake，场景光照才会正确。</strong></p>
<h2 id="光照设置-1"><a href="#光照设置-1" class="headerlink" title="光照设置"></a>光照设置</h2><p>光照设置有下面三块：</p>
<ol>
<li>Realtime Lighting.</li>
<li>Mixed Lighting.</li>
<li>Lightmapping Setting.</li>
</ol>
<p>###Realtime Lighting</p>
<p>这个下面只有一个开关。Realtime Global Illumination，用于控制是否生成Realtime GI贴图。</p>
<p>如果不选择。那么对于LightMap Static打开的物体受光就会发生改变：</p>
<p>从   :</p>
<p><strong>Realtime GI贴图 + Baked GI贴图 + realtime 光的直接光照 + mix 光的直接光照。</strong> </p>
<p>变成 :</p>
<p>​                                   <strong>Baked GI贴图 + realtime 光的直接光照 + mix 光的直接光照</strong>。</p>
<h3 id="Mixed-Lighting"><a href="#Mixed-Lighting" class="headerlink" title="Mixed Lighting"></a>Mixed Lighting</h3><p>这个下面有一个开关，Baked  Global Illumination用于控制是否生成Baked GI贴图。</p>
<p>效果和上面的Realtime Global Illumination一致。</p>
<p>还有一个选项Lighting Mode。这个用于控制MixLight对于ShadowMask之类的类容有所影响，对于前面的内容没有影响。</p>
<p>下面是三种设置情况对应的物体接受光照贴图的情况：</p>
<p>1.Realtime GI开Baked GI开</p>
<p><img src="/../../images/10.%E5%85%89%E7%85%A7%E8%AE%BE%E7%BD%AE1.PNG"></p>
<p>2.Realtime GI关Baked GI开</p>
<p><img src="/../../images/10.%E5%85%89%E7%85%A7%E8%AE%BE%E7%BD%AE2.PNG"></p>
<p>3.Realtime GI开Baked GI关</p>
<p><img src="/../../images/10.%E5%85%89%E7%85%A7%E8%AE%BE%E7%BD%AE3.PNG"></p>
<h3 id="Lightmapping-Setting"><a href="#Lightmapping-Setting" class="headerlink" title="Lightmapping Setting"></a>Lightmapping Setting</h3><p>这个主要用来控制 <strong>Baked GI贴图</strong>如何生成。</p>
<p>Directional Mode 开始 对于<strong>Baked GI贴图</strong>和<strong>Realtime GI贴图</strong>同时生效。</p>

      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/10.Lighting%E8%AE%BE%E7%BD%AE/" title="光照设置">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/1.%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/1.%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/" itemprop="url">代码结构</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h1><p>hdrp的所有渲染过程描述在HDRenderPipeline类的Render方法当中：</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">namespace</span> <span class="hljs-title">UnityEngine.Experimental.Rendering.HDPipeline</span><br>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HDRenderPipeline</span> &#123;<br>	...<br>		 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Render</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">		 	ScriptableRenderContext renderContext, Camera[] cameras</span></span><br><span class="hljs-params"><span class="hljs-function">		 	</span>)</span><br><span class="hljs-function">	...</span><br><span class="hljs-function">	&#125;</span><br><span class="hljs-function">&#125;</span><br></code></pre></td></tr></table></figure>

<h1 id="Render方法"><a href="#Render方法" class="headerlink" title="Render方法"></a>Render方法</h1><p>render方法当中的主要输入的ScriptableRenderContext和Camera列表：</p>
<p>ScriptableRenderContext：定义状态、收集渲染命令。</p>
<p>摄像机列表</p>
<h2 id="render主要过程"><a href="#render主要过程" class="headerlink" title="render主要过程"></a>render主要过程</h2><p>收件进行物体剪裁</p>
<p>然后调用一系列DrawRenderers和CommandBuffer</p>
<p>最终提交</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Render</span>(<span class="hljs-params">ScriptableRenderContext renderContext, Camera[] cameras</span>)</span><br>&#123;<br>  	<span class="hljs-comment">//调用父类方法</span><br>  	<span class="hljs-keyword">base</span>.Render(renderContext, cameras);<br>  <br>  	<span class="hljs-comment">//渲染时间控制</span><br>    &#123;<br><br>    &#125;<br>  <br>  	<span class="hljs-comment">// 渲染平面反射 ：统计需要渲染的反射类型：反射探针 和 平面反射</span><br>  	<span class="hljs-comment">// 通过深层调用可以发现最终调用的是 renderCamera.Render();</span><br>    ReflectionSystem.RenderAllRealtimeProbes(probeTypeToRender);<br>  <br>  	<span class="hljs-comment">// 更新HDRP assets 设置</span><br>    m_Asset.UpdateDirtyFrameSettings();<br>  <br>    <span class="hljs-comment">// 为每个摄像机循环渲染</span><br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> camera <span class="hljs-keyword">in</span> cameras)<br>    &#123;<br>      RenderPipeline.BeginCameraRendering(camera);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="为每个摄像机循环渲染"><a href="#为每个摄像机循环渲染" class="headerlink" title="为每个摄像机循环渲染"></a>为每个摄像机循环渲染</h2><h3 id="准备设置参数"><a href="#准备设置参数" class="headerlink" title="准备设置参数"></a>准备设置参数</h3><figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">if</span> (camera == <span class="hljs-literal">null</span>) <span class="hljs-keyword">continue</span>;<br><br><span class="hljs-comment">// 首先从摄像机上获取摄像机设置。</span><br><span class="hljs-keyword">var</span> additionalCameraData = camera.GetComponent&lt;HDAdditionalCameraData&gt;();<br>FrameSettings srcFrameSettings;<br><span class="hljs-comment">// 如果有这个组件则从组件当中获取最新设置FrameSettings。</span><br><span class="hljs-keyword">if</span> (additionalCameraData)<br>&#123;                additionalCameraData.UpdateDirtyFrameSettings(assetFrameSettingsIsDirty, m_Asset.GetFrameSettings());<br> srcFrameSettings = additionalCameraData.GetFrameSettings();<br> &#125;<br><span class="hljs-comment">// 如果没有则从HDRenderPipelineAsset中获取设置</span><br><span class="hljs-keyword">else</span><br>&#123;<br>    srcFrameSettings = m_Asset.GetFrameSettings();<br>&#125;<br><br><span class="hljs-comment">//  根据各方面内容初始化帧设置。</span><br>   FrameSettings currentFrameSettings = <span class="hljs-keyword">new</span> FrameSettings();<br> FrameSettings.InitializeFrameSettings(camera, m_Asset.GetRenderPipelineSettings(), srcFrameSettings, <span class="hljs-keyword">ref</span> currentFrameSettings);<br><br><br></code></pre></td></tr></table></figure>



<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">//初始化commandbuffer来提交主要的渲染命令</span><br><span class="hljs-keyword">var</span> cmd = CommandBufferPool.Get(<span class="hljs-string">&quot;&quot;</span>);<br><br><span class="hljs-comment">// 完全自定义内容的摄像机，不进入渲染过程</span><br><span class="hljs-keyword">if</span> (additionalCameraData <br>&amp;&amp; additionalCameraData.renderingPath == HDAdditionalCameraData.RenderingPath.FullscreenPassthrough)<br>&#123;<br>  <span class="hljs-comment">// 直接提交一个空的command buffer执行</span><br>  <span class="hljs-comment">// 这里思考一下我们的Command在哪里起作用</span><br>  renderContext.ExecuteCommandBuffer(cmd);<br>  CommandBufferPool.Release(cmd);<br>  renderContext.Submit();<br>  <span class="hljs-keyword">continue</span>;<br>&#125;<br><br><span class="hljs-comment">// 渲染反射：如果注意就可以发现，上面也有一个RenderAllRealtimeViewerDependentProbes区别在于上面的没有提供摄像机，一个是静态的、一个是为当前摄像机渲染的动态的。</span><br><span class="hljs-keyword">if</span> (camera.cameraType != CameraType.Reflection &amp;&amp; camera.cameraType != CameraType.Preview &amp;&amp; !camera.orthographic) ReflectionSystem.RenderAllRealtimeViewerDependentProbesFor(ReflectionProbeType.PlanarReflection, camera);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">可以查看反射探针和镜面反射探针，都保存在下面的数组中</span><br><span class="hljs-comment">m_PlanarReflectionProbe_PerCamera_RealtimeUpdate</span><br><span class="hljs-comment">m_PlanarReflectionProbe_RealtimeUpdate_WorkArray</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-comment">// 初始化材质资源，材质列表中每个材质需要的资源初始化。用cmd来申请</span><br><span class="hljs-comment">// m_MaterialList如何填充的？</span><br><span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> material <span class="hljs-keyword">in</span> m_MaterialList)<br>   material.RenderInit(cmd);<br><br><span class="hljs-comment">// 使用ProfilingSamplig采样渲染</span><br><span class="hljs-comment">// 填充CommandBuffer来指定渲染过程</span><br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;HDRenderPipeline::Render&quot;</span>, CustomSamplerId.HDRenderPipelineRender.GetSampler()))<br>&#123;<br>   <br>&#125;<br><br><span class="hljs-comment">// 执行组装好的CommandBuffer</span><br>renderContext.ExecuteCommandBuffer(cmd);<br><span class="hljs-comment">// 释放</span><br>CommandBufferPool.Release(cmd);<br><span class="hljs-comment">// 提交</span><br>renderContext.Submit();<br><br><span class="hljs-comment">// 和调试相关的内容暂时忽略</span><br><span class="hljs-keyword">if</span> (m_CurrentDebugDisplaySettings.fullScreenDebugMode == FullScreenDebugMode.ScreenSpaceTracing)<br>&#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="填充CommandBuffer来指定渲染过程"><a href="#填充CommandBuffer来指定渲染过程" class="headerlink" title="填充CommandBuffer来指定渲染过程"></a>填充CommandBuffer来指定渲染过程</h4><figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c#"><br><span class="hljs-comment">// 初始化设置  @@</span><br>m_LightLoop.NewFrame(currentFrameSettings);<br><br><span class="hljs-comment">// 根据摄像机类型设置m_CurrentDebugDisplaySettings</span><br><span class="hljs-keyword">if</span> (camera.cameraType == CameraType.Reflection || camera.cameraType == CameraType.Preview)<br>&#123;<br>  m_CurrentDebugDisplaySettings = s_NeutralDebugDisplaySettings;<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  m_CurrentDebugDisplaySettings = m_DebugDisplaySettings;<br>&#125;<br><br><span class="hljs-comment">// Volume相关的处理</span><br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;Volume Update&quot;</span>, CustomSamplerId.VolumeUpdate.GetSampler()))<br>&#123;<br>&#125;<br><br><span class="hljs-comment">// 或处理判断</span><br><span class="hljs-keyword">var</span> postProcessLayer = camera.GetComponent&lt;PostProcessLayer&gt;();<br><span class="hljs-comment">// Disable post process if we enable debug mode or if the post process layer is disabled</span><br><span class="hljs-keyword">if</span> (m_CurrentDebugDisplaySettings.IsDebugDisplayRemovePostprocess() || !HDUtils.IsPostProcessingActive(postProcessLayer))<br>&#123;<br>  currentFrameSettings.enablePostprocess = <span class="hljs-literal">false</span>;<br>&#125;<br><span class="hljs-comment">// 摄像机HDCamera设置，体积光系统？</span><br><span class="hljs-keyword">var</span> hdCamera = HDCamera.Get(camera);<br><span class="hljs-keyword">if</span> (hdCamera == <span class="hljs-literal">null</span>)<br>&#123;<br>  	hdCamera = HDCamera.Create(camera, m_VolumetricLightingSystem);<br>&#125;<br>hdCamera.Update(currentFrameSettings, postProcessLayer, m_VolumetricLightingSystem);<br>Resize(hdCamera);<br>ApplyDebugDisplaySettings(hdCamera, cmd);<br>UpdateShadowSettings(hdCamera);<br>m_SkyManager.UpdateCurrentSkySettings(hdCamera);<br></code></pre></td></tr></table></figure>

<h4 id="剪裁"><a href="#剪裁" class="headerlink" title="剪裁"></a>剪裁</h4><figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c#">ScriptableCullingParameters cullingParams;<br><span class="hljs-keyword">if</span> (!CullResults.GetCullingParameters(camera, hdCamera.frameSettings.enableStereo, <span class="hljs-keyword">out</span> cullingParams))<br>&#123;<br>  renderContext.Submit();<br>  <span class="hljs-keyword">continue</span>;<br>&#125;<br>m_LightLoop.UpdateCullingParameters(<span class="hljs-keyword">ref</span> cullingParams);<br>hdCamera.UpdateStereoDependentState(<span class="hljs-keyword">ref</span> cullingParams);<br></code></pre></td></tr></table></figure>

<p>####一堆看不懂的设置</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableDBuffer)<br>&#123;<br>  <span class="hljs-comment">// decal system needs to be updated with current camera, it needs it to set up culling and light list generation parameters</span><br>  DecalSystem.instance.CurrentCamera = camera;<br>  DecalSystem.instance.BeginCull();<br>&#125;<br><br>ReflectionSystem.PrepareCull(camera, m_ReflectionProbeCullResults);<br><br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;CullResults.Cull&quot;</span>, CustomSamplerId.CullResultsCull.GetSampler()))<br>&#123;<br>  CullResults.Cull(<span class="hljs-keyword">ref</span> cullingParams, renderContext, <span class="hljs-keyword">ref</span> m_CullResults);<br>&#125;<br><br>m_ReflectionProbeCullResults.Cull();<br><br>m_DbufferManager.EnableDBUffer = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;DBufferPrepareDrawData&quot;</span>, CustomSamplerId.DBufferPrepareDrawData.GetSampler()))<br>&#123;<br>  <span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableDBuffer)<br>  &#123;<br>    DecalSystem.instance.EndCull();<br>    m_DbufferManager.EnableDBUffer = <span class="hljs-literal">true</span>;              <span class="hljs-comment">// mesh decals are renderers managed by c++ runtime and we have no way to query if any are visible, so set to true</span><br>    DecalSystem.instance.UpdateCachedMaterialData();    <span class="hljs-comment">// textures, alpha or fade distances could&#x27;ve changed</span><br>    DecalSystem.instance.CreateDrawData();              <span class="hljs-comment">// prepare data is separate from draw</span><br>    DecalSystem.instance.UpdateTextureAtlas(cmd);       <span class="hljs-comment">// as this is only used for transparent pass, would&#x27;ve been nice not to have to do this if no transparent renderers are visible, needs to happen after CreateDrawData</span><br>  &#125;<br>&#125;<br>renderContext.SetupCameraProperties(camera, hdCamera.frameSettings.enableStereo);<br><br>PushGlobalParams(hdCamera, cmd, diffusionProfileSettings);<br><br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Find a correct place to bind these material textures</span><br><span class="hljs-comment">// We have to bind the material specific global parameters in this mode</span><br>m_MaterialList.ForEach(material =&gt; material.Bind());<br><br><span class="hljs-comment">// Frustum cull density volumes on the CPU. Can be performed as soon as the camera is set up.</span><br>DensityVolumeList densityVolumes = m_VolumetricLightingSystem.PrepareVisibleDensityVolumeList(hdCamera, cmd, m_Time);<br><br><span class="hljs-comment">// Note: Legacy Unity behave like this for ShadowMask</span><br><span class="hljs-comment">// When you select ShadowMask in Lighting panel it recompile shaders on the fly with the SHADOW_MASK keyword.</span><br><span class="hljs-comment">// However there is no C# function that we can query to know what mode have been select in Lighting Panel and it will be wrong anyway. Lighting Panel setup what will be the next bake mode. But until light is bake, it is wrong.</span><br><span class="hljs-comment">// Currently to know if you need shadow mask you need to go through all visible lights (of CullResult), check the LightBakingOutput struct and look at lightmapBakeType/mixedLightingMode. If one light have shadow mask bake mode, then you need shadow mask features (i.e extra Gbuffer).</span><br><span class="hljs-comment">// It mean that when we build a standalone player, if we detect a light with bake shadow mask, we generate all shader variant (with and without shadow mask) and at runtime, when a bake shadow mask light is visible, we dynamically allocate an extra GBuffer and switch the shader.</span><br><span class="hljs-comment">// So the first thing to do is to go through all the light: PrepareLightsForGPU</span><br><span class="hljs-built_in">bool</span> enableBakeShadowMask;<br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;TP_PrepareLightsForGPU&quot;</span>, CustomSamplerId.TPPrepareLightsForGPU.GetSampler()))<br>&#123;<br>  enableBakeShadowMask = m_LightLoop.PrepareLightsForGPU(cmd, hdCamera, m_ShadowSettings, m_CullResults, m_ReflectionProbeCullResults, densityVolumes);<br>&#125;<br>ConfigureForShadowMask(enableBakeShadowMask, cmd);<br><br></code></pre></td></tr></table></figure>

<h4 id="正式开始渲染-必要部分1"><a href="#正式开始渲染-必要部分1" class="headerlink" title="正式开始渲染:必要部分1"></a>正式开始渲染:必要部分1</h4><figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c#">StartStereoRendering(renderContext, hdCamera);<br>ClearBuffers(hdCamera, cmd);<br><br><span class="hljs-comment">// 预先深度</span><br>RenderDepthPrepass(m_CullResults, hdCamera, renderContext, cmd);<br><br><span class="hljs-comment">// 渲染深度给Decal使用</span><br>RenderDBuffer(hdCamera, cmd, renderContext, m_CullResults);<br><br><span class="hljs-comment">// 渲染Gbuffer</span><br>RenderGBuffer(m_CullResults, hdCamera, enableBakeShadowMask, renderContext, cmd);<br><br><span class="hljs-comment">// 绑定NormalBuffer到某个外部纹理？？</span><br>m_NormalBufferManager.BindNormalBuffers(cmd);<br><br><span class="hljs-comment">// 渲染深度和深度金字塔</span><br>CopyDepthBufferIfNeeded(cmd);<br>RenderDepthPyramid(hdCamera, cmd, renderContext, FullScreenDebugMode.DepthPyramid);<br><br><span class="hljs-comment">// 渲染MotionVector？？</span><br>RenderObjectsVelocity(m_CullResults, hdCamera, renderContext, cmd);<br>RenderCameraVelocity(m_CullResults, hdCamera, renderContext, cmd);<br><br><span class="hljs-comment">// 设置全局的深度纹理</span><br>cmd.SetGlobalTexture(HDShaderIDs._CameraDepthTexture, GetDepthTexture());<br><br><span class="hljs-comment">// 天空盒更新</span><br>UpdateSkyEnvironment(hdCamera, cmd);<br><br>StopStereoRendering(renderContext, hdCamera);<br><br><span class="hljs-keyword">if</span> (m_CurrentDebugDisplaySettings.IsDebugMaterialDisplayEnabled())<br>&#123;<br>  RenderDebugViewMaterial(m_CullResults, hdCamera, renderContext, cmd);<br><br>  PushColorPickerDebugTexture(cmd, m_CameraColorBuffer, hdCamera);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-comment">//正式开始渲染:必要部分2</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>####正式开始渲染:必要部分2 </p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c#">StartStereoRendering(renderContext, hdCamera);<br><br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;Render SSAO&quot;</span>, CustomSamplerId.RenderSSAO.GetSampler()))<br>&#123;<br>	<span class="hljs-comment">//渲染SSAO，屏幕空间环境光，这里需要PostProcessing？？？</span><br>  RenderSSAO(cmd, hdCamera, renderContext, postProcessLayer);<br>&#125;<br><br><br><span class="hljs-comment">// FeatureVariamts ??? 和Stencil相关</span><br><span class="hljs-keyword">if</span> (m_LightLoop.GetFeatureVariantsEnabled())<br>&#123;<br>  <span class="hljs-comment">// For material classification we use compute shader and so can&#x27;t read into the stencil, so prepare it.</span><br>  <span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;Clear and copy stencil texture&quot;</span>, CustomSamplerId.ClearAndCopyStencilTexture.GetSampler()))<br>  &#123;<br>    HDUtils.SetRenderTarget(cmd, hdCamera, m_CameraStencilBufferCopy, ClearFlag.Color, CoreUtils.clearColorAllBlack);<br><br>    <span class="hljs-comment">// In the material classification shader we will simply test is we are no lighting</span><br>    <span class="hljs-comment">// Use ShaderPassID 1 =&gt; &quot;Pass 1 - Write 1 if value different from stencilRef to output&quot;</span><br>    HDUtils.DrawFullScreen(cmd, hdCamera, m_CopyStencilForNoLighting, m_CameraStencilBufferCopy, m_CameraDepthStencilBuffer, <span class="hljs-literal">null</span>, <span class="hljs-number">1</span>);<br>  &#125;<br>&#125;<br><br>StopStereoRendering(renderContext, hdCamera);<br><br><span class="hljs-comment">// 异步计算阴影？？</span><br>GPUFence buildGPULightListsCompleteFence = <span class="hljs-keyword">new</span> GPUFence();<br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableAsyncCompute)<br>&#123;<br>  GPUFence startFence = cmd.CreateGPUFence();<br>  renderContext.ExecuteCommandBuffer(cmd);<br>  cmd.Clear();<br><br>  buildGPULightListsCompleteFence = m_LightLoop.BuildGPULightListsAsyncBegin(hdCamera, renderContext, m_CameraDepthStencilBuffer, m_CameraStencilBufferCopy, startFence, m_SkyManager.IsLightingSkyValid());<br>&#125;<br><br><span class="hljs-comment">//正式开始渲染:必要部分3 </span><br></code></pre></td></tr></table></figure>



<p>####正式开始渲染:必要部分3 </p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs c#"> <span class="hljs-comment">// 渲染阴影</span><br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;Render shadows&quot;</span>, CustomSamplerId.RenderShadows.GetSampler()))<br>&#123;<br>  m_LightLoop.RenderShadows(renderContext, cmd, m_CullResults);<br><br>  <span class="hljs-comment">// Overwrite camera properties set during the shadow pass with the original camera properties.</span><br>  renderContext.SetupCameraProperties(camera, hdCamera.frameSettings.enableStereo);<br>  hdCamera.SetupGlobalParams(cmd, m_Time, m_LastTime, m_FrameCount);<br>  <span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableStereo)<br>    hdCamera.SetupGlobalStereoParams(cmd);<br>&#125;<br><br><span class="hljs-comment">// 渲染deffered直接阴影</span><br><span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;Deferred directional shadows&quot;</span>, CustomSamplerId.RenderDeferredDirectionalShadow.GetSampler()))<br>&#123;<br>    <span class="hljs-comment">// When debug is enabled we need to clear otherwise we may see non-shadows areas with stale values.</span><br>    <span class="hljs-keyword">if</span> (m_CurrentDebugDisplaySettings.fullScreenDebugMode == FullScreenDebugMode.DeferredShadows)<br>    &#123;<br>      HDUtils.SetRenderTarget(cmd, hdCamera, m_DeferredShadowBuffer, ClearFlag.Color, CoreUtils.clearColorAllBlack);<br>    &#125;<br><br>    m_LightLoop.RenderDeferredDirectionalShadow(hdCamera, m_DeferredShadowBuffer, GetDepthTexture(), cmd);<br>    PushFullScreenDebugTexture(hdCamera, cmd, m_DeferredShadowBuffer, FullScreenDebugMode.DeferredShadows);<br>&#125;<br><br><span class="hljs-comment">// 异步计算阴影结束？</span><br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableAsyncCompute)<br>&#123;<br>  m_LightLoop.BuildGPULightListAsyncEnd(hdCamera, cmd, buildGPULightListsCompleteFence);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-comment">// 配置光照列表</span><br>  <span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;Build Light list&quot;</span>, CustomSamplerId.BuildLightList.GetSampler()))<br>  &#123;<br>    m_LightLoop.BuildGPULightLists(hdCamera, cmd, m_CameraDepthStencilBuffer, m_CameraStencilBufferCopy, m_SkyManager.IsLightingSkyValid());<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 和体积光相关的雾参数</span><br>&#123;<br>  <span class="hljs-comment">// Set fog parameters for volumetric lighting.</span><br>  <span class="hljs-keyword">var</span> visualEnv = VolumeManager.instance.stack.GetComponent&lt;VisualEnvironment&gt;();<br>  visualEnv.PushFogShaderParameters(hdCamera, cmd);<br>&#125;<br><br><span class="hljs-comment">// 体素化阶段</span><br>m_VolumetricLightingSystem.VolumeVoxelizationPass(hdCamera, cmd, m_FrameCount, densityVolumes);<br><br><span class="hljs-comment">// 渲染体积光</span><br>m_VolumetricLightingSystem.VolumetricLightingPass(hdCamera, cmd, m_FrameCount);<br><br><span class="hljs-comment">// 渲染延迟光照</span><br>RenderDeferredLighting(hdCamera, cmd);<br><br><span class="hljs-comment">// Might float this higher if we enable stereo w/ deferred</span><br>StartStereoRendering(renderContext, hdCamera);<br><br><span class="hljs-comment">// 渲染前向物体</span><br>RenderForward(m_CullResults, hdCamera, renderContext, cmd, ForwardPass.Opaque);<br><br><span class="hljs-comment">// SSS pass here handle both SSS material from deferred and forward</span><br>m_SSSBufferManager.SubsurfaceScatteringPass(hdCamera, cmd, diffusionProfileSettings,m_CameraColorBuffer, m_CameraSssDiffuseLightingBuffer, m_CameraDepthStencilBuffer, GetDepthTexture());<br><br><span class="hljs-comment">// 渲染天空</span><br>RenderSky(hdCamera, cmd);<br><br><span class="hljs-comment">// 渲染每一个反射物体</span><br>RenderForward(m_CullResults, hdCamera, renderContext, cmd, ForwardPass.PreRefraction);<br><br><span class="hljs-comment">// 渲染颜色金字塔</span><br>RenderColorPyramid(hdCamera, cmd, renderContext, <span class="hljs-literal">true</span>);<br><br><span class="hljs-comment">// 渲染前向物体</span><br><span class="hljs-comment">// Render all type of transparent forward (unlit, lit, complex (hair...)) to keep the sorting between transparent objects.</span><br>RenderForward(m_CullResults, hdCamera, renderContext, cmd, ForwardPass.Transparent);<br><br><span class="hljs-comment">// 渲染错误</span><br><span class="hljs-comment">// Render All forward error</span><br>RenderForwardError(m_CullResults, hdCamera, renderContext, cmd);<br><br><span class="hljs-comment">// Fill depth buffer to reduce artifact for transparent object during postprocess</span><br><span class="hljs-comment">// 给后处理渲染透明物体的深度</span><br>RenderTransparentDepthPostpass(m_CullResults, hdCamera, renderContext, cmd, ForwardPass.Transparent);<br><br><span class="hljs-comment">// 渲染颜色金字塔2</span><br>RenderColorPyramid(hdCamera, cmd, renderContext, <span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// ？？</span><br>AccumulateDistortion(m_CullResults, hdCamera, renderContext, cmd);<br>RenderDistortion(hdCamera, cmd, m_Asset.renderPipelineResources);<br><br>StopStereoRendering(renderContext, hdCamera);<br><br><span class="hljs-comment">// 测设相关</span><br>PushFullScreenDebugTexture(hdCamera, cmd, m_CameraColorBuffer, FullScreenDebugMode.NanTracker);<br>PushColorPickerDebugTexture(hdCamera, cmd, m_CameraColorBuffer);<br><br>StartStereoRendering(renderContext, hdCamera);<br><br><span class="hljs-comment">// 后处理</span><br><span class="hljs-comment">// Final blit</span><br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enablePostprocess)<br>&#123;<br>  RenderPostProcess(hdCamera, cmd, postProcessLayer);<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-keyword">using</span> (<span class="hljs-keyword">new</span> ProfilingSample(cmd, <span class="hljs-string">&quot;Blit to final RT&quot;</span>, CustomSamplerId.BlitToFinalRT.GetSampler()))<br>  &#123;<br>    <span class="hljs-comment">// This Blit will flip the screen on anything other than openGL</span><br>    HDUtils.BlitCameraTexture(cmd, hdCamera, m_CameraColorBuffer, BuiltinRenderTextureType.CameraTarget);<br>  &#125;<br>&#125;<br><br>StopStereoRendering(renderContext, hdCamera);<br><span class="hljs-comment">// Pushes to XR headset and/or display mirror</span><br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableStereo)<br>  renderContext.StereoEndRender(hdCamera.camera);<br></code></pre></td></tr></table></figure>



<h1 id="具体渲染方法"><a href="#具体渲染方法" class="headerlink" title="具体渲染方法"></a>具体渲染方法</h1><h2 id="RenderDepthPrepass"><a href="#RenderDepthPrepass" class="headerlink" title="RenderDepthPrepass"></a>RenderDepthPrepass</h2><p>渲染内容：根据渲染设置提前渲染深度。</p>
<p><strong>在Deferred渲染过程中，我们可以使用Forward不透明材质，这些材质需要渲染深度，来得到正确的灯光列表</strong></p>
<p><strong>之后再Deferred光照阶段（deferred lighting pass），不去渲染这些forward的不透明材质。</strong></p>
<p>在deferred模式下，默认是没有forward不透明物体的。但是如果有了，就需要ForwardOnly强行渲染不透明物体。这时候Forward没用，只有FOrwardOnly有用。同时也需要有DepthForwardOnly。</p>
<p>如果forward材质没有深度，则光照可能不正确。</p>
<p>  &#x2F;&#x2F; Forward material always output normal buffer (unless they don’t participate to shading)</p>
<p>&#x2F;&#x2F; Deferred material never output normal buffer</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">//Asset当中开启了Forward Only，则只会渲染前向物体。则depthonly 和depthforwardonly都会渲染。</span><br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableForwardRenderingOnly)<br>&#123;<br>  HDUtils.SetRenderTarget 设置渲染目标<br>  <span class="hljs-comment">// Full forward: Output normal buffer for both forward and forwardOnly</span><br> RenderOpaqueRenderList(cull, <span class="hljs-comment">// 剪裁结果保存了所有Render</span><br>                        hdCamera, <span class="hljs-comment">//摄像机参数</span><br>                        renderContext,  <span class="hljs-comment">// 渲染上下文</span><br>                        cmd, <br>                        <span class="hljs-comment">// 需要渲染的pass ，所有深度pass都会渲染</span><br>                        m_DepthOnlyAndDepthForwardOnlyPassNames,<br>                        <span class="hljs-number">0</span>, <br>                        <span class="hljs-comment">// 渲染队列</span><br>                        HDRenderQueue.k_RenderQueue_AllOpaque);<br>&#125;<br><span class="hljs-comment">// 如果是deferred render的物体（也就是没有开启Forward Only设置）开启了DepthPrepass,或者开启了深度DBuffer，就会给Deferred渲染的物体也进行prepass深度渲染，一般主需要渲染forward的深度就可以。</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableDepthPrepassWithDeferredRendering || m_DbufferManager.EnableDBUffer)<br>&#123;<br>  HDUtils.SetRenderTarget(cmd, hdCamera, m_CameraDepthStencilBuffer);<br>  <span class="hljs-comment">// 用DepthOnly写入deferred的深度</span><br>  RenderOpaqueRenderList(cull, hdCamera, renderContext, cmd, m_DepthOnlyPassNames, <span class="hljs-number">0</span>, HDRenderQueue.k_RenderQueue_AllOpaque);<br><br>  	<span class="hljs-comment">//与上面不同的是颜色缓存使用了法线 RTI（rendertexture index）也就是forward物体需要填充法线纹理。</span><br>  HDUtils.SetRenderTarget(cmd, hdCamera, <br>                          m_NormalBufferManager.GetBuffersRTI(),<br>                          m_CameraDepthStencilBuffer);<br><br>  <span class="hljs-comment">// 用DepthForwardOnly写入Forward物体的深度</span><br>  RenderOpaqueRenderList(cull, hdCamera, renderContext, cmd, m_DepthForwardOnlyPassNames, <span class="hljs-number">0</span>, HDRenderQueue.k_RenderQueue_AllOpaque);<br><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-comment">// Deferred with partial depth prepass</span><br>&#123;<br>  cmd.DisableShaderKeyword(<span class="hljs-string">&quot;WRITE_NORMAL_BUFFER&quot;</span>);<br><span class="hljs-comment">// 给Deferred alpha tested materials必须渲染prepass。</span><br>  HDUtils.SetRenderTarget(cmd, hdCamera, m_CameraDepthStencilBuffer);<br>  <span class="hljs-keyword">var</span> renderQueueRange = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = (<span class="hljs-built_in">int</span>)RenderQueue.AlphaTest, max = (<span class="hljs-built_in">int</span>)RenderQueue.GeometryLast - <span class="hljs-number">1</span> &#125;;<br>  RenderOpaqueRenderList(cull, hdCamera, renderContext, cmd, m_DepthOnlyPassNames, <span class="hljs-number">0</span>, renderQueueRange);<br><br>  HDUtils.SetRenderTarget(cmd, hdCamera, m_NormalBufferManager.GetBuffersRTI(), m_CameraDepthStencilBuffer);<br><span class="hljs-comment">// 在deferred 模式下强行渲染Forward不透明物体，需要有DepthForwardonlyPath，否则光照错误。</span><br>  RenderOpaqueRenderList(cull, hdCamera, renderContext, cmd, m_DepthForwardOnlyPassNames, <span class="hljs-number">0</span>, HDRenderQueue.k_RenderQueue_AllOpaque);<br><br>&#125;<br><br><span class="hljs-comment">// 透明物体的Prepass</span><br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableTransparentPrepass)<br>&#123;<br>	RenderTransparentRenderList(cull, hdCamera, <br>                                renderContext, <br>                                cmd, <br>                                m_TransparentDepthPrepassNames);<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="RenderDBuffer"><a href="#RenderDBuffer" class="headerlink" title="RenderDBuffer"></a>RenderDBuffer</h2><p>如果需要深度贴图则绑定一个DBuffer，需要接受Decal的也在这里渲染</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">//如果开启Dbuffer</span><br><span class="hljs-keyword">if</span> (!hdCamera.frameSettings.enableDBuffer)<br>  <span class="hljs-keyword">return</span>;<br><br><br>  <span class="hljs-comment">// We need to copy depth buffer texture if we want to bind it at this stage</span><br><span class="hljs-comment">// 复制了一份CameraDepthStencil</span><br>  CopyDepthBufferIfNeeded(cmd);<br><br>  <span class="hljs-comment">// Depth texture is now ready, bind it. 把复制得到的深度设置成全局深度</span><br><span class="hljs-comment">// _CameraDepthTexture在这里生产</span><br>  cmd.SetGlobalTexture(HDShaderIDs._CameraDepthTexture, GetDepthTexture());<br>  m_DbufferManager.ClearTargets(cmd, hdCamera);<br>  HDUtils.SetRenderTarget(cmd, hdCamera, m_DbufferManager.GetBuffersRTI(), m_CameraDepthStencilBuffer); <span class="hljs-comment">// do not clear anymore</span><br>  m_DbufferManager.SetHTile(m_DbufferManager.bufferCount, cmd);<br>  renderContext.ExecuteCommandBuffer(cmd);<br>  cmd.Clear();<br><br><span class="hljs-comment">// 渲染空pass  绘制DBufferMesh Pass decal？</span><br><span class="hljs-comment">// 使用——MeshDecalsPass 渲染一个_DecalHTileTexture纹理</span><br>  DrawRendererSettings drawSettings = <span class="hljs-keyword">new</span> DrawRendererSettings(hdCamera.camera, HDShaderPassNames.s_EmptyName)<br>  &#123;<br>    rendererConfiguration = <span class="hljs-number">0</span>,<br>    sorting = &#123; flags = SortFlags.CommonOpaque &#125;<br>  &#125;;<br>  drawSettings.SetShaderPassName(<span class="hljs-number">0</span>, HDShaderPassNames.s_MeshDecalsName);<br>  FilterRenderersSettings filterRenderersSettings = <span class="hljs-keyword">new</span> FilterRenderersSettings(<span class="hljs-literal">true</span>)<br>  &#123;<br>    renderQueueRange = HDRenderQueue.k_RenderQueue_AllOpaque<br>  &#125;;<br><span class="hljs-comment">// 渲染需要接受decal的物体</span><br>  renderContext.DrawRenderers(cullResults.visibleRenderers, <span class="hljs-keyword">ref</span> drawSettings, filterRenderersSettings);<br><br><span class="hljs-comment">// 渲染Decal到Dbuffer  HtileDepth？</span><br>  DecalSystem.instance.RenderIntoDBuffer(cmd);<br>  m_DbufferManager.UnSetHTile(cmd);<br>  m_DbufferManager.SetHTileTexture(cmd);  <span class="hljs-comment">// mask per 8x8 tile used for optimization when looking up dbuffer values</span><br><br></code></pre></td></tr></table></figure>



<h2 id="RenderGBuffer"><a href="#RenderGBuffer" class="headerlink" title="RenderGBuffer"></a>RenderGBuffer</h2><figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// 只渲染前向物体</span><br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableForwardRenderingOnly)<br>  <span class="hljs-keyword">return</span>;<br><span class="hljs-comment">// 设置Gbuffer目标，和深度</span><br>HDUtils.SetRenderTarget(cmd, hdCamera, m_GbufferManager.GetBuffersRTI(enableShadowMask), m_CameraDepthStencilBuffer);<br><span class="hljs-comment">// 进行渲染，渲染的过程填充深度</span><br>RenderOpaqueRenderList(cull, hdCamera, renderContext, cmd, HDShaderPassNames.s_GBufferName, m_currentRendererConfigurationBakedLighting, HDRenderQueue.k_RenderQueue_AllOpaque);<br><span class="hljs-comment">// 设置Gbuffer _GBufferTexture0 - 4</span><br>m_GbufferManager.BindBufferAsTextures(cmd);<br></code></pre></td></tr></table></figure>



<h2 id="RenderDepthPyramid"><a href="#RenderDepthPyramid" class="headerlink" title="RenderDepthPyramid"></a>RenderDepthPyramid</h2><p>computeShader计算深度金字塔</p>
<h2 id="RenderObjectsVelocity"><a href="#RenderObjectsVelocity" class="headerlink" title="RenderObjectsVelocity"></a>RenderObjectsVelocity</h2><p>渲染物体速度			</p>
<h2 id="RenderCameraVelocity"><a href="#RenderCameraVelocity" class="headerlink" title="RenderCameraVelocity"></a>RenderCameraVelocity</h2><p>渲染摄像机速度</p>
<p>##cmd.SetGlobalTexture();</p>
<p>设置全局深度贴图</p>
<h2 id="RenderSSAO"><a href="#RenderSSAO" class="headerlink" title="RenderSSAO"></a>RenderSSAO</h2><p>SSAO, Shadow, Build light list, deferred shadow, material and light classification can be parallelize with Async compute</p>
<p>同时计算各种效果</p>
<h2 id="m-VolumetricLightingSystem"><a href="#m-VolumetricLightingSystem" class="headerlink" title="m_VolumetricLightingSystem"></a>m_VolumetricLightingSystem</h2><p>和体积光相关的操作</p>
<h2 id="m-LightLoop-RenderShadows"><a href="#m-LightLoop-RenderShadows" class="headerlink" title="m_LightLoop.RenderShadows"></a>m_LightLoop.RenderShadows</h2><p>渲染阴影</p>
<h2 id="m-LightLoop-RenderDeferredDirectionalShadow"><a href="#m-LightLoop-RenderDeferredDirectionalShadow" class="headerlink" title="m_LightLoop.RenderDeferredDirectionalShadow"></a>m_LightLoop.RenderDeferredDirectionalShadow</h2><h2 id="RenderDeferredLighting"><a href="#RenderDeferredLighting" class="headerlink" title="RenderDeferredLighting"></a>RenderDeferredLighting</h2><p>计算deferred物体光照 </p>
<p>实现了ComputeShader和Shader两个版本的Deferred计算。</p>
<h2 id="RenderForward"><a href="#RenderForward" class="headerlink" title="RenderForward"></a>RenderForward</h2><p>ForwardPass.Opaque Pass</p>
<p>在不同模式下的渲染：</p>
<p>在RenderForward的过程中，渲染那个pass会根据设置不同发生改变。</p>
<p>如果启用ForwardOnly Rnedering，那么Forward和ForwardOnly就都会渲染，无论是不透明物体还是透明物体。</p>
<p>如果是Deferred模式，那么对于transparent Forward和ForwardOnly就都会渲染，对于opaque就只会渲染ForwardOnly。</p>
<p>所以ForwardOnly 和Forward是互斥的。</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// Debug相关内容</span><br><span class="hljs-built_in">string</span> profileName;<br><span class="hljs-keyword">if</span> (m_CurrentDebugDisplaySettings.IsDebugDisplayEnabled())<br>&#123;<br>  profileName = k_ForwardPassDebugName[(<span class="hljs-built_in">int</span>)pass];<br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  profileName = k_ForwardPassName[(<span class="hljs-built_in">int</span>)pass];<br>&#125;<br><br><br><span class="hljs-comment">// 获取摄像机</span><br><span class="hljs-keyword">var</span> camera = hdCamera.camera;<br><br><span class="hljs-comment">// ???????</span><br>m_LightLoop.RenderForward(camera, cmd, pass == ForwardPass.Opaque);<br><br><span class="hljs-comment">// 屏幕空间Tracing</span><br><span class="hljs-keyword">var</span> debugScreenSpaceTracing = m_CurrentDebugDisplaySettings.fullScreenDebugMode == FullScreenDebugMode.ScreenSpaceTracing;<br><br><span class="hljs-comment">// 不透明物体</span><br><span class="hljs-keyword">if</span> (pass == ForwardPass.Opaque)<br>&#123;<br>  <span class="hljs-comment">// 使用SSS效果</span><br>  <span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableSubsurfaceScattering)<br>  &#123;<br>    RenderTargetIdentifier[] m_MRTWithSSS = <span class="hljs-keyword">new</span> RenderTargetIdentifier[<span class="hljs-number">2</span> + m_SSSBufferManager.sssBufferCount];<br>    <span class="hljs-comment">// 准备所有的SSS需要的buffer</span><br>    m_MRTWithSSS[<span class="hljs-number">0</span>] = m_CameraColorBuffer; <span class="hljs-comment">// Store the specular color</span><br>    m_MRTWithSSS[<span class="hljs-number">1</span>] = m_CameraSssDiffuseLightingBuffer;<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; m_SSSBufferManager.sssBufferCount; ++i)<br>    &#123;<br>      m_MRTWithSSS[i + <span class="hljs-number">2</span>] = m_SSSBufferManager.GetSSSBuffer(i);<br>    &#125;<br><br>    HDUtils.SetRenderTarget(cmd, hdCamera, m_MRTWithSSS, m_CameraDepthStencilBuffer);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>	<span class="hljs-comment">//不使用SSS效果，则就是用一般的Depth和COlorbuffer</span><br>    HDUtils.SetRenderTarget(cmd, hdCamera, m_CameraColorBuffer, m_CameraDepthStencilBuffer);<br>  &#125;<br><br>  <span class="hljs-comment">//根据渲染设置使用不同的Forwardpass  ： ForwardOnly Or Forward</span><br>  <span class="hljs-keyword">var</span> passNames = hdCamera.frameSettings.enableForwardRenderingOnly<br>    ? m_ForwardAndForwardOnlyPassNames<br>    : m_ForwardOnlyPassNames;<br>  <span class="hljs-comment">// 调试模式</span><br>  <span class="hljs-keyword">var</span> debugSSTThisPass = debugScreenSpaceTracing &amp;&amp; (m_CurrentDebugDisplaySettings.lightingDebugSettings.debugLightingMode == DebugLightingMode.ScreenSpaceTracingReflection);<br><br>  <span class="hljs-keyword">if</span> (debugSSTThisPass)<br>    cmd.SetRandomWriteTarget(<span class="hljs-number">7</span>, m_DebugScreenSpaceTracingData);<br>  <br>  <span class="hljs-comment">// 渲染不透明物体</span><br>  RenderOpaqueRenderList(cullResults, hdCamera, renderContext, cmd, passNames, m_currentRendererConfigurationBakedLighting);<br>  <br>  <span class="hljs-keyword">if</span> (debugSSTThisPass)<br>    cmd.ClearRandomWriteTargets();<br>&#125;<br><span class="hljs-comment">//渲染透明物体</span><br><span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-comment">// 设置透明物体渲染目标</span><br>  HDUtils.SetRenderTarget(cmd, hdCamera, m_CameraColorBuffer, m_CameraDepthStencilBuffer);<br>  <span class="hljs-comment">// 使用dbuffer 并且有Decal 则SetAtlas？？？？</span><br>  <span class="hljs-keyword">if</span> ((hdCamera.frameSettings.enableDBuffer) &amp;&amp; (DecalSystem.m_DecalDatasCount &gt; <span class="hljs-number">0</span>)) <br>  &#123;<br>    DecalSystem.instance.SetAtlas(cmd); <span class="hljs-comment">// for clustered decals</span><br>  &#125;<br><br>  <span class="hljs-keyword">var</span> debugSSTThisPass = debugScreenSpaceTracing &amp;&amp; (m_CurrentDebugDisplaySettings.lightingDebugSettings.debugLightingMode == DebugLightingMode.ScreenSpaceTracingRefraction);<br>  <span class="hljs-keyword">if</span> (debugSSTThisPass)<br>    cmd.SetRandomWriteTarget(<span class="hljs-number">7</span>, m_DebugScreenSpaceTracingData);<br>  <br>  <span class="hljs-comment">// 渲染透明物体</span><br>  RenderTransparentRenderList(cullResults, hdCamera, renderContext, cmd, m_AllTransparentPassNames, m_currentRendererConfigurationBakedLighting, pass == ForwardPass.PreRefraction ? HDRenderQueue.k_RenderQueue_PreRefraction : HDRenderQueue.k_RenderQueue_Transparent);<br>  <br>  <span class="hljs-keyword">if</span> (debugSSTThisPass)<br>    cmd.ClearRandomWriteTargets();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//渲染的ShaderPass</span><br>   var passNames = hdCamera.frameSettings.enableForwardRenderingOnly<br>                        ? m_ForwardAndForwardOnlyPassNames<br>                        : m_ForwardOnlyPassNames;<br><br><span class="hljs-comment">// HDShaderPassNames.s_SRPDefaultUnlitName  是一个FallBack</span><br>ShaderPassName[] m_ForwardAndForwardOnlyPassNames = &#123; HDShaderPassNames.s_ForwardOnlyName, <br>                                                     HDShaderPassNames.s_ForwardName, <br>                                                     HDShaderPassNames.s_SRPDefaultUnlitName &#125;;<br>ShaderPassName[] m_ForwardOnlyPassNames = &#123; HDShaderPassNames.s_ForwardOnlyName, <br>                                           HDShaderPassNames.s_SRPDefaultUnlitName &#125;;<br><br><span class="hljs-comment">// 渲染队列</span><br>RenderQueueRange k_RenderQueue_AllOpaque = new RenderQueueRange &#123; <br>  min = (<span class="hljs-type">int</span>)Priority.Opaque,    <span class="hljs-number">2000</span><br>  max = (<span class="hljs-type">int</span>)Priority.OpaqueLast &#125;; <span class="hljs-number">2500</span><br></code></pre></td></tr></table></figure>



<h2 id="RenderSky"><a href="#RenderSky" class="headerlink" title="RenderSky"></a>RenderSky</h2><h2 id="RenderForward-1"><a href="#RenderForward-1" class="headerlink" title="RenderForward"></a>RenderForward</h2><p>forwardPass.PreRefraction Pass</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">//渲染的pass</span><br>ShaderPassName[] m_AllTransparentPassNames = &#123;  HDShaderPassNames.s_TransparentBackfaceName,<br>                                                        HDShaderPassNames.s_ForwardOnlyName,<br>                                                        HDShaderPassNames.s_ForwardName,<br>                                                        HDShaderPassNames.s_SRPDefaultUnlitName &#125;;<br><span class="hljs-comment">// 渲染队列</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_Transparent = <span class="hljs-keyword">new</span> RenderQueueRange &#123; <br>   min = (<span class="hljs-built_in">int</span>)Priority.PreRefractionFirst,  <span class="hljs-number">2750</span> - <span class="hljs-number">100</span><br>   max = (<span class="hljs-built_in">int</span>)Priority.PreRefractionLast &#125;; <span class="hljs-number">2750</span> + <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure>





<h2 id="RenderColorPyramid"><a href="#RenderColorPyramid" class="headerlink" title="RenderColorPyramid"></a>RenderColorPyramid</h2><p>Gpu计算,会根据是否需要Bloom，Distortion，SSR等内容来判断是否使用。</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c#">RenderColorPyramid(hdCamera, cmd, renderContext, <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure>





<h2 id="RenderForward-2"><a href="#RenderForward-2" class="headerlink" title="RenderForward"></a>RenderForward</h2><p>ForwardPass.Transparent Pass</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">ShaderPassName[] m_AllTransparentPassNames = &#123;  							HDShaderPassNames.s_TransparentBackfaceName,<br>                                                        HDShaderPassNames.s_ForwardOnlyName,<br>                                                        HDShaderPassNames.s_ForwardName,<br>                                                        HDShaderPassNames.s_SRPDefaultUnlitName &#125;;<br><br><span class="hljs-comment">//渲染队列</span><br> public <span class="hljs-type">static</span> readonly RenderQueueRange k_RenderQueue_PreRefraction = new RenderQueueRange &#123; min = (<span class="hljs-type">int</span>)Priority.TransparentFirst,     <span class="hljs-number">3000</span> - <span class="hljs-number">100</span><br>max = (<span class="hljs-type">int</span>)Priority. TransparentLast&#125;;    <span class="hljs-number">3000</span> + <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure>

<p>##RednerTransparentDepthPostpass</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">if</span> (!hdCamera.frameSettings.enableTransparentPostpass)<br><span class="hljs-keyword">return</span>;<br><br><br>HDUtils.SetRenderTarget(cmd, hdCamera, m_CameraDepthStencilBuffer);<br>RenderTransparentRenderList(cullResults, hdCamera, renderContext, cmd, m_TransparentDepthPostpassNames);<br><br><span class="hljs-comment">//使用Pass</span><br>TransparentDepthPostpass<br></code></pre></td></tr></table></figure>
<p>##RenderColorPyramid</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c#">RenderColorPyramid(hdCamera, cmd, renderContext, <span class="hljs-literal">false</span>); <br></code></pre></td></tr></table></figure>



<h2 id="渲染错误的Pass"><a href="#渲染错误的Pass" class="headerlink" title="渲染错误的Pass"></a>渲染错误的Pass</h2><p>都是之前遗留的PassName</p>
<pre><code>    public static readonly ShaderPassName s_AlwaysName = new ShaderPassName(&quot;Always&quot;);
    public static readonly ShaderPassName s_ForwardBaseName = new ShaderPassName(&quot;ForwardBase&quot;);
    public static readonly ShaderPassName s_DeferredName = new ShaderPassName(&quot;Deferred&quot;);
    public static readonly ShaderPassName s_PrepassBaseName = new ShaderPassName(&quot;PrepassBase&quot;);
    public static readonly ShaderPassName s_VertexName = new ShaderPassName(&quot;Vertex&quot;);
    public static readonly ShaderPassName s_VertexLMRGBMName = new ShaderPassName(&quot;VertexLMRGBM&quot;);
    public static readonly ShaderPassName s_VertexLMName = new ShaderPassName(&quot;VertexLM&quot;);
</code></pre>
<h2 id="AccumulateDistortion-amp-RenderDistortion"><a href="#AccumulateDistortion-amp-RenderDistortion" class="headerlink" title="AccumulateDistortion &amp; RenderDistortion"></a>AccumulateDistortion &amp; RenderDistortion</h2><p>失真计算？</p>
<h2 id="RenderPostProcess"><a href="#RenderPostProcess" class="headerlink" title="RenderPostProcess"></a>RenderPostProcess</h2><p>后处理</p>
<h2 id="进一步调用"><a href="#进一步调用" class="headerlink" title="进一步调用"></a>进一步调用</h2><h3 id="RenderOpaqueRenderList"><a href="#RenderOpaqueRenderList" class="headerlink" title="RenderOpaqueRenderList"></a>RenderOpaqueRenderList</h3><figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">RenderTransparentRenderList</span>(<span class="hljs-params">CullResults cull,</span></span><br><span class="hljs-params"><span class="hljs-function">            HDCamera hdCamera,</span></span><br><span class="hljs-params"><span class="hljs-function">            ScriptableRenderContext renderContext,</span></span><br><span class="hljs-params"><span class="hljs-function">            CommandBuffer cmd,</span></span><br><span class="hljs-params"><span class="hljs-function">            ShaderPassName passName,</span></span><br><span class="hljs-params"><span class="hljs-function">            RendererConfiguration rendererConfiguration = <span class="hljs-number">0</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">            RenderQueueRange? inRenderQueueRange = <span class="hljs-literal">null</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">            RenderStateBlock? stateBlock = <span class="hljs-literal">null</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">            Material overrideMaterial = <span class="hljs-literal">null</span></span></span><br><span class="hljs-params"><span class="hljs-function">                                 </span></span><br><span class="hljs-params"><span class="hljs-function"><span class="hljs-keyword">void</span> RenderTransparentRenderList(CullResults cull,</span></span><br><span class="hljs-params"><span class="hljs-function">            HDCamera hdCamera,</span></span><br><span class="hljs-params"><span class="hljs-function">            ScriptableRenderContext renderContext,</span></span><br><span class="hljs-params"><span class="hljs-function">            CommandBuffer cmd, </span></span><br><span class="hljs-params"><span class="hljs-function">            ShaderPassName[] passName,   //  多个pass</span></span><br><span class="hljs-params"><span class="hljs-function">            RendererConfiguration rendererConfiguration = <span class="hljs-number">0</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">            RenderQueueRange? inRenderQueueRange = <span class="hljs-literal">null</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">            RenderStateBlock? stateBlock = <span class="hljs-literal">null</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">            Material overrideMaterial = <span class="hljs-literal">null</span></span></span><br></code></pre></td></tr></table></figure>

<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-comment">// 想要渲染不都名物体 </span><br><span class="hljs-keyword">if</span> (!hdCamera.frameSettings.enableOpaqueObjects)<br>     <span class="hljs-keyword">return</span>;<br><span class="hljs-comment">// DrawRender 不再Command当中渲染，所以想把之前的做完。</span><br>renderContext.ExecuteCommandBuffer(cmd);<br>cmd.Clear();<br><br><span class="hljs-comment">// 设置绘制参数，排序方式</span><br><span class="hljs-keyword">var</span> drawSettings = <span class="hljs-keyword">new</span> DrawRendererSettings(hdCamera.camera, HDShaderPassNames.s_EmptyName)<br>&#123;<br>  rendererConfiguration = rendererConfiguration,<br>  sorting = &#123; flags = SortFlags.CommonOpaque &#125;<br>&#125;;<br><br><span class="hljs-comment">// 收集需要渲染的pass Name</span><br><span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; passNames.Length; ++i)<br>&#123;<br>  drawSettings.SetShaderPassName(i, passNames[i]);<br>&#125;<br><br><span class="hljs-comment">// 设置全局材质，渲染某些通用效果的时候使用</span><br><span class="hljs-keyword">if</span> (overrideMaterial != <span class="hljs-literal">null</span>)<br>  drawSettings.SetOverrideMaterial(overrideMaterial, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// 渲染队列，指定还是范围</span><br><span class="hljs-keyword">var</span> filterSettings = <span class="hljs-keyword">new</span> FilterRenderersSettings(<span class="hljs-literal">true</span>)<br>&#123;<br>  renderQueueRange = inRenderQueueRange == <span class="hljs-literal">null</span> ? <br>    HDRenderQueue.k_RenderQueue_AllOpaque : inRenderQueueRange.Value<br>      <span class="hljs-comment">//2000 -  2500</span><br>&#125;;<br><br><span class="hljs-keyword">if</span> (stateBlock == <span class="hljs-literal">null</span>)<br>  renderContext.DrawRenderers(cull.visibleRenderers, <span class="hljs-keyword">ref</span> drawSettings, filterSettings);<br><span class="hljs-keyword">else</span><br>  renderContext.DrawRenderers(cull.visibleRenderers, <span class="hljs-keyword">ref</span> drawSettings, filterSettings, stateBlock.Value);<br></code></pre></td></tr></table></figure>



<p>###RenderTransparentRenderList</p>
<h1 id="初始化与HDRenderPipelineAsset"><a href="#初始化与HDRenderPipelineAsset" class="headerlink" title="初始化与HDRenderPipelineAsset"></a>初始化与HDRenderPipelineAsset</h1>
      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/1.%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84/" title="代码结构">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/3.%E6%B8%B2%E6%9F%93%E5%8F%82%E6%95%B0/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/3.%E6%B8%B2%E6%9F%93%E5%8F%82%E6%95%B0/" itemprop="url">渲染队列</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <p>#.渲染队列</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HDRenderQueue</span><br>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> k_TransparentPriorityQueueRange = <span class="hljs-number">100</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> Priority<br>&#123;<br>Background = UnityEngine.Rendering.RenderQueue.Background,<br>Opaque = UnityEngine.Rendering.RenderQueue.Geometry,<br>OpaqueAlphaTest = UnityEngine.Rendering.RenderQueue.AlphaTest,<br><span class="hljs-comment">// Warning: we must not change Geometry last value to stay compatible with occlusion</span><br>OpaqueLast = UnityEngine.Rendering.RenderQueue.GeometryLast,<br><span class="hljs-comment">// For transparent pass we define a range of 200 value to define the priority</span><br><span class="hljs-comment">// Warning: Be sure no range are overlapping</span><br>PreRefractionFirst = <span class="hljs-number">2750</span> - k_TransparentPriorityQueueRange,<br>PreRefraction = <span class="hljs-number">2750</span>,<br>PreRefractionLast = <span class="hljs-number">2750</span> + k_TransparentPriorityQueueRange,<br>TransparentFirst = UnityEngine.Rendering.RenderQueue.Transparent - k_TransparentPriorityQueueRange,<br>Transparent = UnityEngine.Rendering.RenderQueue.Transparent,<br>TransparentLast = UnityEngine.Rendering.RenderQueue.Transparent + k_TransparentPriorityQueueRange,<br>Overlay = UnityEngine.Rendering.RenderQueue.Overlay<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_OpaqueNoAlphaTest = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = (<span class="hljs-built_in">int</span>)Priority.Opaque, max = (<span class="hljs-built_in">int</span>)Priority.OpaqueAlphaTest - <span class="hljs-number">1</span> &#125;;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_OpaqueAlphaTest = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = (<span class="hljs-built_in">int</span>)Priority.OpaqueAlphaTest, max = (<span class="hljs-built_in">int</span>)Priority.OpaqueLast &#125;;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_AllOpaque = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = (<span class="hljs-built_in">int</span>)Priority.Opaque, max = (<span class="hljs-built_in">int</span>)Priority.OpaqueLast &#125;;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_PreRefraction = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = (<span class="hljs-built_in">int</span>)Priority.PreRefractionFirst, max = (<span class="hljs-built_in">int</span>)Priority.PreRefractionLast &#125;;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_Transparent = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = (<span class="hljs-built_in">int</span>)Priority.TransparentFirst, max = (<span class="hljs-built_in">int</span>)Priority.TransparentLast &#125;;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_AllTransparent = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = (<span class="hljs-built_in">int</span>)Priority.PreRefractionFirst, max = (<span class="hljs-built_in">int</span>)Priority.TransparentLast &#125;;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> RenderQueueRange k_RenderQueue_All = <span class="hljs-keyword">new</span> RenderQueueRange &#123; min = <span class="hljs-number">0</span>, max = <span class="hljs-number">5000</span> &#125;;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2内置纹理</p>
<figure class="hljs highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br></pre></td><td class="code"><pre><code class="hljs c#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HDShaderIDs</span><br>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowDatasExp = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowDatasExp&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowPayloads = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowPayloads&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowmapExp_VSM_0 = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowmapExp_VSM_0&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowmapExp_VSM_1 = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowmapExp_VSM_1&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowmapExp_VSM_2 = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowmapExp_VSM_2&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowmapExp_PCF = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowmapExp_PCF&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_LayeredSingleIdxBuffer = Shader.PropertyToID(<span class="hljs-string">&quot;g_LayeredSingleIdxBuffer&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnvLightIndexShift = Shader.PropertyToID(<span class="hljs-string">&quot;_EnvLightIndexShift&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DensityVolumeIndexShift = Shader.PropertyToID(<span class="hljs-string">&quot;_DensityVolumeIndexShift&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_isOrthographic = Shader.PropertyToID(<span class="hljs-string">&quot;g_isOrthographic&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_iNrVisibLights = Shader.PropertyToID(<span class="hljs-string">&quot;g_iNrVisibLights&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_mScrProjection = Shader.PropertyToID(<span class="hljs-string">&quot;g_mScrProjection&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_mInvScrProjection = Shader.PropertyToID(<span class="hljs-string">&quot;g_mInvScrProjection&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_mScrProjectionArr = Shader.PropertyToID(<span class="hljs-string">&quot;g_mScrProjectionArr&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_mInvScrProjectionArr = Shader.PropertyToID(<span class="hljs-string">&quot;g_mInvScrProjectionArr&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_iLog2NumClusters = Shader.PropertyToID(<span class="hljs-string">&quot;g_iLog2NumClusters&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_screenSize = Shader.PropertyToID(<span class="hljs-string">&quot;g_screenSize&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_iNumSamplesMSAA = Shader.PropertyToID(<span class="hljs-string">&quot;g_iNumSamplesMSAA&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_fNearPlane = Shader.PropertyToID(<span class="hljs-string">&quot;g_fNearPlane&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_fFarPlane = Shader.PropertyToID(<span class="hljs-string">&quot;g_fFarPlane&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_fClustScale = Shader.PropertyToID(<span class="hljs-string">&quot;g_fClustScale&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_fClustBase = Shader.PropertyToID(<span class="hljs-string">&quot;g_fClustBase&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_depth_tex = Shader.PropertyToID(<span class="hljs-string">&quot;g_depth_tex&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_vLayeredLightList = Shader.PropertyToID(<span class="hljs-string">&quot;g_vLayeredLightList&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_LayeredOffset = Shader.PropertyToID(<span class="hljs-string">&quot;g_LayeredOffset&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_vBigTileLightList = Shader.PropertyToID(<span class="hljs-string">&quot;g_vBigTileLightList&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_logBaseBuffer = Shader.PropertyToID(<span class="hljs-string">&quot;g_logBaseBuffer&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_vBoundsBuffer = Shader.PropertyToID(<span class="hljs-string">&quot;g_vBoundsBuffer&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LightVolumeData = Shader.PropertyToID(<span class="hljs-string">&quot;_LightVolumeData&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_data = Shader.PropertyToID(<span class="hljs-string">&quot;g_data&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_mProjectionArr = Shader.PropertyToID(<span class="hljs-string">&quot;g_mProjectionArr&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_mInvProjectionArr = Shader.PropertyToID(<span class="hljs-string">&quot;g_mInvProjectionArr&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_viDimensions = Shader.PropertyToID(<span class="hljs-string">&quot;g_viDimensions&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_vLightList = Shader.PropertyToID(<span class="hljs-string">&quot;g_vLightList&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_BaseFeatureFlags = Shader.PropertyToID(<span class="hljs-string">&quot;g_BaseFeatureFlags&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_TileFeatureFlags = Shader.PropertyToID(<span class="hljs-string">&quot;g_TileFeatureFlags&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_DispatchIndirectBuffer = Shader.PropertyToID(<span class="hljs-string">&quot;g_DispatchIndirectBuffer&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_TileList = Shader.PropertyToID(<span class="hljs-string">&quot;g_TileList&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_NumTiles = Shader.PropertyToID(<span class="hljs-string">&quot;g_NumTiles&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_NumTilesX = Shader.PropertyToID(<span class="hljs-string">&quot;g_NumTilesX&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NumTiles = Shader.PropertyToID(<span class="hljs-string">&quot;_NumTiles&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CookieTextures = Shader.PropertyToID(<span class="hljs-string">&quot;_CookieTextures&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CookieCubeTextures = Shader.PropertyToID(<span class="hljs-string">&quot;_CookieCubeTextures&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnvCubemapTextures = Shader.PropertyToID(<span class="hljs-string">&quot;_EnvCubemapTextures&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Env2DTextures = Shader.PropertyToID(<span class="hljs-string">&quot;_Env2DTextures&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Env2DCaptureVP = Shader.PropertyToID(<span class="hljs-string">&quot;_Env2DCaptureVP&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DirectionalLightDatas = Shader.PropertyToID(<span class="hljs-string">&quot;_DirectionalLightDatas&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DirectionalLightCount = Shader.PropertyToID(<span class="hljs-string">&quot;_DirectionalLightCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LightDatas = Shader.PropertyToID(<span class="hljs-string">&quot;_LightDatas&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _PunctualLightCount = Shader.PropertyToID(<span class="hljs-string">&quot;_PunctualLightCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _AreaLightCount = Shader.PropertyToID(<span class="hljs-string">&quot;_AreaLightCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_vLightListGlobal = Shader.PropertyToID(<span class="hljs-string">&quot;g_vLightListGlobal&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnvLightDatas = Shader.PropertyToID(<span class="hljs-string">&quot;_EnvLightDatas&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnvLightCount = Shader.PropertyToID(<span class="hljs-string">&quot;_EnvLightCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnvProxyCount = Shader.PropertyToID(<span class="hljs-string">&quot;_EnvProxyCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowDatas = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowDatas&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NumTileFtplX = Shader.PropertyToID(<span class="hljs-string">&quot;_NumTileFtplX&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NumTileFtplY = Shader.PropertyToID(<span class="hljs-string">&quot;_NumTileFtplY&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NumTileClusteredX = Shader.PropertyToID(<span class="hljs-string">&quot;_NumTileClusteredX&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NumTileClusteredY = Shader.PropertyToID(<span class="hljs-string">&quot;_NumTileClusteredY&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_isLogBaseBufferEnabled = Shader.PropertyToID(<span class="hljs-string">&quot;g_isLogBaseBufferEnabled&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_vLayeredOffsetsBuffer = Shader.PropertyToID(<span class="hljs-string">&quot;g_vLayeredOffsetsBuffer&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ViewTilesFlags = Shader.PropertyToID(<span class="hljs-string">&quot;_ViewTilesFlags&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _MousePixelCoord = Shader.PropertyToID(<span class="hljs-string">&quot;_MousePixelCoord&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _MouseClickPixelCoord = Shader.PropertyToID(<span class="hljs-string">&quot;_MouseClickPixelCoord&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugStep = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugStep&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugFont = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugFont&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugExposure = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugExposure&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugScreenSpaceTracingData = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugScreenSpaceTracingData&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShowGrid = Shader.PropertyToID(<span class="hljs-string">&quot;_ShowGrid&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShowSSRaySampledColor = Shader.PropertyToID(<span class="hljs-string">&quot;_ShowSSRaySampledColor&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShowDepthPyramidDebug = Shader.PropertyToID(<span class="hljs-string">&quot;_ShowDepthPyramidDebug&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugViewMaterial = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugViewMaterial&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugLightingMode = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugLightingMode&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugLightingSubMode = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugLightingSubMode&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugLightingAlbedo = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugLightingAlbedo&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugLightingSmoothness = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugLightingSmoothness&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugLightingNormal = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugLightingNormal&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugLightingSpecularColor = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugLightingSpecularColor&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _AmbientOcclusionTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_AmbientOcclusionTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugMipMapMode = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugMipMapMode&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _UseTileLightList = Shader.PropertyToID(<span class="hljs-string">&quot;_UseTileLightList&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _FrameCount     = Shader.PropertyToID(<span class="hljs-string">&quot;_FrameCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Time           = Shader.PropertyToID(<span class="hljs-string">&quot;_Time&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LastTime       = Shader.PropertyToID(<span class="hljs-string">&quot;_LastTime&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SinTime        = Shader.PropertyToID(<span class="hljs-string">&quot;_SinTime&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CosTime        = Shader.PropertyToID(<span class="hljs-string">&quot;_CosTime&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> unity_DeltaTime = Shader.PropertyToID(<span class="hljs-string">&quot;unity_DeltaTime&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnvLightSkyEnabled = Shader.PropertyToID(<span class="hljs-string">&quot;_EnvLightSkyEnabled&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _AmbientOcclusionParam = Shader.PropertyToID(<span class="hljs-string">&quot;_AmbientOcclusionParam&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SkyTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_SkyTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SkyTextureMipCount = Shader.PropertyToID(<span class="hljs-string">&quot;_SkyTextureMipCount&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnableSubsurfaceScattering = Shader.PropertyToID(<span class="hljs-string">&quot;_EnableSubsurfaceScattering&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _TransmittanceMultiplier = Shader.PropertyToID(<span class="hljs-string">&quot;_TransmittanceMultiplier&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _TexturingModeFlags = Shader.PropertyToID(<span class="hljs-string">&quot;_TexturingModeFlags&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _TransmissionFlags = Shader.PropertyToID(<span class="hljs-string">&quot;_TransmissionFlags&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ThicknessRemaps = Shader.PropertyToID(<span class="hljs-string">&quot;_ThicknessRemaps&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShapeParams = Shader.PropertyToID(<span class="hljs-string">&quot;_ShapeParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _HalfRcpVariancesAndWeights = Shader.PropertyToID(<span class="hljs-string">&quot;_HalfRcpVariancesAndWeights&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _TransmissionTintsAndFresnel0 = Shader.PropertyToID(<span class="hljs-string">&quot;_TransmissionTintsAndFresnel0&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> specularLightingUAV = Shader.PropertyToID(<span class="hljs-string">&quot;specularLightingUAV&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> diffuseLightingUAV = Shader.PropertyToID(<span class="hljs-string">&quot;diffuseLightingUAV&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> g_TileListOffset = Shader.PropertyToID(<span class="hljs-string">&quot;g_TileListOffset&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LtcData = Shader.PropertyToID(<span class="hljs-string">&quot;_LtcData&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LtcGGXMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_LtcGGXMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LtcDisneyDiffuseMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_LtcDisneyDiffuseMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LtcMultiGGXFresnelDisneyDiffuse = Shader.PropertyToID(<span class="hljs-string">&quot;_LtcMultiGGXFresnelDisneyDiffuse&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DeferredShadowTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_DeferredShadowTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DeferredShadowTextureUAV = Shader.PropertyToID(<span class="hljs-string">&quot;_DeferredShadowTextureUAV&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DirectionalShadowIndex = Shader.PropertyToID(<span class="hljs-string">&quot;_DirectionalShadowIndex&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DirectionalContactShadowParams = Shader.PropertyToID(<span class="hljs-string">&quot;_ScreenSpaceShadowsParameters&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DirectionalContactShadowSampleCount = Shader.PropertyToID(<span class="hljs-string">&quot;_SampleCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DirectionalLightDirection = Shader.PropertyToID(<span class="hljs-string">&quot;_DirectionalLightDirection&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _PunctualLightPosition = Shader.PropertyToID(<span class="hljs-string">&quot;_PunctualLightPosition&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _StencilMask = Shader.PropertyToID(<span class="hljs-string">&quot;_StencilMask&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _StencilRef = Shader.PropertyToID(<span class="hljs-string">&quot;_StencilRef&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _StencilCmp = Shader.PropertyToID(<span class="hljs-string">&quot;_StencilCmp&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InputDepth = Shader.PropertyToID(<span class="hljs-string">&quot;_InputDepthTexture&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SrcBlend = Shader.PropertyToID(<span class="hljs-string">&quot;_SrcBlend&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DstBlend = Shader.PropertyToID(<span class="hljs-string">&quot;_DstBlend&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSSHTile = Shader.PropertyToID(<span class="hljs-string">&quot;_SSSHTile&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _StencilTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_StencilTexture&quot;</span>);<br><br>  <span class="hljs-comment">// all decal properties</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NormalToWorldID = Shader.PropertyToID(<span class="hljs-string">&quot;_NormalToWorld&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DecalAtlas2DID = Shader.PropertyToID(<span class="hljs-string">&quot;_DecalAtlas2D&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DecalAtlasID = Shader.PropertyToID(<span class="hljs-string">&quot;_DecalAtlas&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DecalHTileTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_DecalHTileTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DecalIndexShift = Shader.PropertyToID(<span class="hljs-string">&quot;_DecalIndexShift&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DecalCount = Shader.PropertyToID(<span class="hljs-string">&quot;_DecalCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DecalDatas = Shader.PropertyToID(<span class="hljs-string">&quot;_DecalDatas&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _WorldSpaceCameraPos = Shader.PropertyToID(<span class="hljs-string">&quot;_WorldSpaceCameraPos&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ViewMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_ViewMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InvViewMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_InvViewMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ProjMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_ProjMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InvProjMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_InvProjMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NonJitteredViewProjMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_NonJitteredViewProjMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ViewProjMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_ViewProjMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InvViewProjMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_InvViewProjMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DetViewMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_DetViewMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ZBufferParams = Shader.PropertyToID(<span class="hljs-string">&quot;_ZBufferParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ProjectionParams = Shader.PropertyToID(<span class="hljs-string">&quot;_ProjectionParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> unity_OrthoParams = Shader.PropertyToID(<span class="hljs-string">&quot;unity_OrthoParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InvProjParam = Shader.PropertyToID(<span class="hljs-string">&quot;_InvProjParam&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ScreenSize = Shader.PropertyToID(<span class="hljs-string">&quot;_ScreenSize&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ScreenParams = Shader.PropertyToID(<span class="hljs-string">&quot;_ScreenParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ScreenToTargetScale = Shader.PropertyToID(<span class="hljs-string">&quot;_ScreenToTargetScale&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _PrevViewProjMatrix = Shader.PropertyToID(<span class="hljs-string">&quot;_PrevViewProjMatrix&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _FrustumPlanes = Shader.PropertyToID(<span class="hljs-string">&quot;_FrustumPlanes&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _TaaFrameRotation = Shader.PropertyToID(<span class="hljs-string">&quot;_TaaFrameRotation&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ViewMatrixStereo = Shader.PropertyToID(<span class="hljs-string">&quot;_ViewMatrixStereo&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ViewProjMatrixStereo = Shader.PropertyToID(<span class="hljs-string">&quot;_ViewProjMatrixStereo&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InvViewMatrixStereo = Shader.PropertyToID(<span class="hljs-string">&quot;_InvViewMatrixStereo&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InvProjMatrixStereo = Shader.PropertyToID(<span class="hljs-string">&quot;_InvProjMatrixStereo&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InvViewProjMatrixStereo = Shader.PropertyToID(<span class="hljs-string">&quot;_InvViewProjMatrixStereo&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DepthTexture                   = Shader.PropertyToID(<span class="hljs-string">&quot;_DepthTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CameraColorTexture             = Shader.PropertyToID(<span class="hljs-string">&quot;_CameraColorTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CameraSssDiffuseLightingBuffer = Shader.PropertyToID(<span class="hljs-string">&quot;_CameraSssDiffuseLightingTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CameraFilteringBuffer          = Shader.PropertyToID(<span class="hljs-string">&quot;_CameraFilteringTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _IrradianceSource               = Shader.PropertyToID(<span class="hljs-string">&quot;_IrradianceSource&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _EnableDBuffer = Shader.PropertyToID(<span class="hljs-string">&quot;_EnableDBuffer&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DecalAtlasResolution = Shader.PropertyToID(<span class="hljs-string">&quot;_DecalAtlasResolution&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span>[] _GBufferTexture =<br>  &#123;<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture0&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture1&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture2&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture3&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture4&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture5&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture6&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_GBufferTexture7&quot;</span>)<br>  &#125;;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span>[] _DBufferTexture =<br>  &#123;<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_DBufferTexture0&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_DBufferTexture1&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_DBufferTexture2&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_DBufferTexture3&quot;</span>)<br>  &#125;;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span>[] _SSSBufferTexture =<br>  &#123;<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_SSSBufferTexture0&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_SSSBufferTexture1&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_SSSBufferTexture2&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_SSSBufferTexture3&quot;</span>),<br>  &#125;;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span>[] _NormalBufferTexture =<br>  &#123;<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_NormalBufferTexture0&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_NormalBufferTexture1&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_NormalBufferTexture2&quot;</span>),<br>    Shader.PropertyToID(<span class="hljs-string">&quot;_NormalBufferTexture3&quot;</span>),<br>  &#125;;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionRayMarchBehindObjects = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionRayMarchBehindObjects&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionRayMaxScreenDistance = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionRayMaxScreenDistance&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionRayBlendScreenDistance = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionRayBlendScreenDistance&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionRayLevel = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionRayLevel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionRayMinLevel = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionRayMinLevel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionRayMaxLevel = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionRayMaxLevel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionRayMaxIterations = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionRayMaxIterations&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionDepthBufferThickness = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionDepthBufferThickness&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSRefractionInvScreenWeightDistance = Shader.PropertyToID(<span class="hljs-string">&quot;_SSRefractionInvScreenWeightDistance&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionRayMarchBehindObjects = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionRayMarchBehindObjects&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionRayMaxScreenDistance = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionRayMaxScreenDistance&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionRayBlendScreenDistance = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionRayBlendScreenDistance&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionRayLevel = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionRayLevel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionRayMinLevel = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionRayMinLevel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionRayMaxLevel = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionRayMaxLevel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionRayMaxIterations = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionRayMaxIterations&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionDepthBufferThickness = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionDepthBufferThickness&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionInvScreenWeightDistance = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionInvScreenWeightDistance&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionProjectionModel = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionProjectionModel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SSReflectionEnabled = Shader.PropertyToID(<span class="hljs-string">&quot;_SSReflectionEnabled&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VelocityTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_VelocityTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShadowMaskTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_ShadowMaskTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DistortionTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_DistortionTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ColorPyramidTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_ColorPyramidTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DepthPyramidTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_DepthPyramidTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ColorPyramidSize = Shader.PropertyToID(<span class="hljs-string">&quot;_ColorPyramidSize&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ColorPyramidScale = Shader.PropertyToID(<span class="hljs-string">&quot;_ColorPyramidScale&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DepthPyramidSize = Shader.PropertyToID(<span class="hljs-string">&quot;_DepthPyramidSize&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DepthPyramidScale = Shader.PropertyToID(<span class="hljs-string">&quot;_DepthPyramidScale&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugColorPickerTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugColorPickerTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ColorPickerMode = Shader.PropertyToID(<span class="hljs-string">&quot;_ColorPickerMode&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ApplyLinearToSRGB = Shader.PropertyToID(<span class="hljs-string">&quot;_ApplyLinearToSRGB&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ColorPickerFontColor = Shader.PropertyToID(<span class="hljs-string">&quot;_ColorPickerFontColor&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _RequireToFlipInputTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_RequireToFlipInputTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _FalseColorEnabled = Shader.PropertyToID(<span class="hljs-string">&quot;_FalseColor&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _FalseColorThresholds = Shader.PropertyToID(<span class="hljs-string">&quot;_FalseColorThresholds&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DebugFullScreenTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_DebugFullScreenTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _BlitTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_BlitTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _BlitScaleBias = Shader.PropertyToID(<span class="hljs-string">&quot;_BlitScaleBias&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _BlitMipLevel = Shader.PropertyToID(<span class="hljs-string">&quot;_BlitMipLevel&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _BlitScaleBiasRt = Shader.PropertyToID(<span class="hljs-string">&quot;_BlitScaleBiasRt&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _WorldScales = Shader.PropertyToID(<span class="hljs-string">&quot;_WorldScales&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _FilterKernels = Shader.PropertyToID(<span class="hljs-string">&quot;_FilterKernels&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _FilterKernelsBasic = Shader.PropertyToID(<span class="hljs-string">&quot;_FilterKernelsBasic&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _HalfRcpWeightedVariances = Shader.PropertyToID(<span class="hljs-string">&quot;_HalfRcpWeightedVariances&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CameraDepthTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_CameraDepthTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CameraMotionVectorsTexture = Shader.PropertyToID(<span class="hljs-string">&quot;_CameraMotionVectorsTexture&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CameraMotionVectorsSize = Shader.PropertyToID(<span class="hljs-string">&quot;_CameraMotionVectorsSize&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CameraMotionVectorsScale = Shader.PropertyToID(<span class="hljs-string">&quot;_CameraMotionVectorsScale&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _FullScreenDebugMode = Shader.PropertyToID(<span class="hljs-string">&quot;_FullScreenDebugMode&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _InputCubemap = Shader.PropertyToID(<span class="hljs-string">&quot;_InputCubemap&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Mipmap = Shader.PropertyToID(<span class="hljs-string">&quot;_Mipmap&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _DiffusionProfile = Shader.PropertyToID(<span class="hljs-string">&quot;_DiffusionProfile&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _MaxRadius = Shader.PropertyToID(<span class="hljs-string">&quot;_MaxRadius&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ShapeParam = Shader.PropertyToID(<span class="hljs-string">&quot;_ShapeParam&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _StdDev1 = Shader.PropertyToID(<span class="hljs-string">&quot;_StdDev1&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _StdDev2 = Shader.PropertyToID(<span class="hljs-string">&quot;_StdDev2&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _LerpWeight = Shader.PropertyToID(<span class="hljs-string">&quot;_LerpWeight&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _HalfRcpVarianceAndWeight1 = Shader.PropertyToID(<span class="hljs-string">&quot;_HalfRcpVarianceAndWeight1&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _HalfRcpVarianceAndWeight2 = Shader.PropertyToID(<span class="hljs-string">&quot;_HalfRcpVarianceAndWeight2&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _TransmissionTint = Shader.PropertyToID(<span class="hljs-string">&quot;_TransmissionTint&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _ThicknessRemap = Shader.PropertyToID(<span class="hljs-string">&quot;_ThicknessRemap&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Cubemap = Shader.PropertyToID(<span class="hljs-string">&quot;_Cubemap&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _SkyParam = Shader.PropertyToID(<span class="hljs-string">&quot;_SkyParam&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _PixelCoordToViewDirWS = Shader.PropertyToID(<span class="hljs-string">&quot;_PixelCoordToViewDirWS&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Size = Shader.PropertyToID(<span class="hljs-string">&quot;_Size&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Source4 = Shader.PropertyToID(<span class="hljs-string">&quot;_Source4&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _Result1 = Shader.PropertyToID(<span class="hljs-string">&quot;_Result1&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _AtmosphericScatteringType      = Shader.PropertyToID(<span class="hljs-string">&quot;_AtmosphericScatteringType&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _AmbientProbeCoeffs             = Shader.PropertyToID(<span class="hljs-string">&quot;_AmbientProbeCoeffs&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _GlobalExtinction               = Shader.PropertyToID(<span class="hljs-string">&quot;_GlobalExtinction&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _GlobalScattering               = Shader.PropertyToID(<span class="hljs-string">&quot;_GlobalScattering&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _GlobalAnisotropy               = Shader.PropertyToID(<span class="hljs-string">&quot;_GlobalAnisotropy&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _CornetteShanksConstant         = Shader.PropertyToID(<span class="hljs-string">&quot;_CornetteShanksConstant&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferResolution              = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferResolution&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferSliceCount              = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferSliceCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferUvScaleAndLimit         = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferUvScaleAndLimit&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferDepthEncodingParams     = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferDepthEncodingParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferDepthDecodingParams     = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferDepthDecodingParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferPrevResolution          = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferPrevResolution&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferPrevSliceCount          = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferPrevSliceCount&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferPrevUvScaleAndLimit     = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferPrevUvScaleAndLimit&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferPrevDepthEncodingParams = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferPrevDepthEncodingParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferPrevDepthDecodingParams = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferPrevDepthDecodingParams&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferCoordToViewDirWS        = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferCoordToViewDirWS&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferDensity                 = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferDensity&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferLighting                = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferLighting&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferLightingIntegral        = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferLightingIntegral&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferLightingHistory         = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferLightingHistory&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferLightingFeedback        = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferLightingFeedback&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VBufferSampleOffset            = Shader.PropertyToID(<span class="hljs-string">&quot;_VBufferSampleOffset&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VolumeBounds                   = Shader.PropertyToID(<span class="hljs-string">&quot;_VolumeBounds&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VolumeData                     = Shader.PropertyToID(<span class="hljs-string">&quot;_VolumeData&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _NumVisibleDensityVolumes       = Shader.PropertyToID(<span class="hljs-string">&quot;_NumVisibleDensityVolumes&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VolumeMaskAtlas                = Shader.PropertyToID(<span class="hljs-string">&quot;_VolumeMaskAtlas&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _VolumeMaskDimensions           = Shader.PropertyToID(<span class="hljs-string">&quot;_VolumeMaskDimensions&quot;</span>);<br><br>  <span class="hljs-comment">// Preintegrated texture name</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _PreIntegratedFGD_GGXDisneyDiffuse = Shader.PropertyToID(<span class="hljs-string">&quot;_PreIntegratedFGD_GGXDisneyDiffuse&quot;</span>);<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> _PreIntegratedFGD_CharlieAndCloth = Shader.PropertyToID(<span class="hljs-string">&quot;_PreIntegratedFGD_CharlieAndCloth&quot;</span>);<br>&#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>


      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/3.%E6%B8%B2%E6%9F%93%E5%8F%82%E6%95%B0/" title="渲染队列">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/4.LitShader%E5%88%86%E6%9E%90/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/4.LitShader%E5%88%86%E6%9E%90/" itemprop="url">Shader代码分析</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="Shader代码分析"><a href="#Shader代码分析" class="headerlink" title="Shader代码分析"></a>Shader代码分析</h1><p>unity HDRP的所有shader的内容都集中在了Lit Shader当中。Shader Graph等内容都是使用的相同的底层结构。</p>
<p>现在我对Lit的整个过程、内部结构和Shader参数进行分析，了解一下新的Shader是如何运作的。</p>
<p>在文档2当中我们看到了目前包括的所有的Shader Pass</p>
<figure class="hljs highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs hlsl">public static readonly string s_EmptyStr = &quot;&quot;;<br>public static readonly string s_ForwardStr = &quot;Forward&quot;;<br>public static readonly string s_DepthOnlyStr = &quot;DepthOnly&quot;;<br>public static readonly string s_DepthForwardOnlyStr = &quot;DepthForwardOnly&quot;;<br>public static readonly string s_ForwardOnlyStr = &quot;ForwardOnly&quot;;<br>public static readonly string s_GBufferStr = &quot;GBuffer&quot;;<br>public static readonly string s_GBufferWithPrepassStr = &quot;GBufferWithPrepass&quot;;<br>public static readonly string s_SRPDefaultUnlitStr = &quot;SRPDefaultUnlit&quot;;<br>public static readonly string s_MotionVectorsStr = &quot;MotionVectors&quot;;<br>public static readonly string s_DistortionVectorsStr = &quot;DistortionVectors&quot;;<br>public static readonly string s_TransparentDepthPrepassStr = &quot;TransparentDepthPrepass&quot;;<br>public static readonly string s_TransparentBackfaceStr = &quot;TransparentBackface&quot;;<br>public static readonly string s_TransparentDepthPostpassStr = &quot;TransparentDepthPostpass&quot;;<br>public static readonly string s_MetaStr = &quot;Meta&quot;;<br>public static readonly string s_ShadowCasterStr = &quot;ShadowCaster&quot;;<br>public static readonly string s_MeshDecalsStr = &quot;DBufferMesh&quot;;<br></code></pre></td></tr></table></figure>

<p>其中主要的包括GBuffer、Forward、DepthOnly、ShadowCaster。现在我们依次对着几个Pass进行分析。</p>
<p>上面每一个Pass的具体代码都在下面的目录中：</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">\Packages\hrdp\Runtime\RenderPipeline\ShaderPass<br></code></pre></td></tr></table></figure>

<p>具体的代码结构基本一致，下面以GbufferPass 进行说明</p>
<h2 id="GBuffer-Pass"><a href="#GBuffer-Pass" class="headerlink" title="GBuffer Pass"></a>GBuffer Pass</h2><p>Gbuffer在Lit当中的完整内容：</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c">Pass<br>&#123;<br>    Name <span class="hljs-string">&quot;GBuffer&quot;</span>  <span class="hljs-comment">// Name is not used</span><br>    Tags &#123; <span class="hljs-string">&quot;LightMode&quot;</span> = <span class="hljs-string">&quot;GBuffer&quot;</span> &#125;<br>    <span class="hljs-comment">// 剪裁模式和深度测试可以进行设置</span><br>    <span class="hljs-comment">// 深入写入必然开启</span><br>    Cull [_CullMode]<br>    ZTest [_ZTestGBuffer]<br>    Stencil<br>    &#123;<br>        WriteMask [_StencilWriteMask]<br>        Ref  [_StencilRef]<br>        Comp Always<br>        Pass Replace<br>    &#125;<br><br>    HLSLPROGRAM<br><br>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> multi_compile _ DEBUG_DISPLAY</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> multi_compile _ LIGHTMAP_ON</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> multi_compile _ DIRLIGHTMAP_COMBINED</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> multi_compile _ DYNAMICLIGHTMAP_ON</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> multi_compile _ SHADOWS_SHADOWMASK</span><br>    <span class="hljs-comment">// Setup DECALS_OFF so the shader stripper can remove variants</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> multi_compile DECALS_OFF DECALS_3RT DECALS_4RT</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> multi_compile _ LIGHT_LAYERS</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _ALPHATEST_ON</span><br>    <span class="hljs-comment">// When we have alpha test, we will force a depth prepass so we always bypass the clip instruction in the GBuffer</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> SHADERPASS_GBUFFER_BYPASS_ALPHA_TEST</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-meta">#<span class="hljs-keyword">define</span> SHADERPASS SHADERPASS_GBUFFER</span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/ShaderLibrary/ShaderVariables.hlsl&quot;</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/Material/Material.hlsl&quot;</span></span><br><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/Material/Lit/Lit.hlsl&quot;</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/Material/Lit/ShaderPass/LitSharePass.hlsl&quot;</span></span><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/Material/Lit/LitData.hlsl&quot;</span></span><br><br>    <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/RenderPipeline/ShaderPass/ShaderPassGBuffer.hlsl&quot;</span></span><br><br>    ENDHLSL<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面Include的文件当中包括大量的函数和工具。其中和Gbuffer相关的主要Vert和Frag函数在<strong>ShaderPassGBuffer.hlsl</strong>文件当中。</p>
<p>这部分主要定义了<strong>Vert</strong>和<strong>Frag</strong>函数，以及<strong>曲面细分</strong>。</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">if</span> SHADERPASS != SHADERPASS_GBUFFER</span><br><span class="hljs-meta">#<span class="hljs-keyword">error</span> SHADERPASS_is_not_correctly_define</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-comment">// 这个Include文件当中包括了顶点数据格式的转换。</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;Packages/com.unity.render-pipelines.high-definition/Runtime/RenderPipeline/ShaderPass/VertMesh.hlsl&quot;</span></span><br><br>PackedVaryingsType <span class="hljs-title function_">Vert</span><span class="hljs-params">(AttributesMesh inputMesh)</span><br>&#123;<br>    VaryingsType varyingsType;<br>  <span class="hljs-comment">//这里包括了坐标空间的转换。和一些必要的参数计算。世界坐标法线、世界坐标位置等等</span><br>    varyingsType.vmesh = VertMesh(inputMesh);<br>  	<span class="hljs-comment">// 调整传递用的结构体，节省空间</span><br>    <span class="hljs-keyword">return</span> PackVaryingsType(varyingsType);<br>&#125;<br><span class="hljs-comment">// 这部分主要是曲面细分</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> TESSELLATION_ON</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Frag</span><span class="hljs-params">(  PackedVaryingsToPS packedInput,</span><br><span class="hljs-params">            OUTPUT_GBUFFER(outGBuffer)</span><br><span class="hljs-params">            #ifdef _DEPTHOFFSET_ON</span><br><span class="hljs-params">            , out <span class="hljs-type">float</span> outputDepth : SV_Depth</span><br><span class="hljs-params">            #endif</span><br><span class="hljs-params">            )</span><br>&#123;<br>	<span class="hljs-comment">// 解析出数据</span><br>    FragInputs input = UnpackVaryingsMeshToFragInputs(packedInput.vmesh);<br><br>    <span class="hljs-comment">// input.positionSS is SV_Position</span><br>    PositionInputs posInput = GetPositionInput(input.positionSS.xy, _ScreenSize.zw, input.positionSS.z, input.positionSS.w, input.positionRWS);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> VARYINGS_NEED_POSITION_WS</span><br>    float3 V = GetWorldSpaceNormalizeViewDir(input.positionRWS);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-comment">// Unused</span><br>    float3 V = float3(<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>); <span class="hljs-comment">// Avoid the division by 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    SurfaceData surfaceData;<br>    BuiltinData builtinData;<br>    GetSurfaceAndBuiltinData(input, V, posInput, surfaceData, builtinData);<br><br>    ENCODE_INTO_GBUFFER(surfaceData, builtinData, posInput.positionSS, outGBuffer);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _DEPTHOFFSET_ON</span><br>    outputDepth = posInput.deviceDepth;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>###VertMesh.hlsl</p>
<p>比较重要的内容为<strong>VertMesh.hlsl</strong>这个文件：主要定义了顶点片段着色器的输入输出和输入输出的拆包和解包。</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">PackVaryingsType 、UnpackVaryingsMeshToFragInputs：<span class="hljs-comment">//输出的拆包和解包函数</span><br>VertMesh：设置顶点参数  包括：法线、切线、世界坐标、纹理坐标、剪裁空间坐标等<br></code></pre></td></tr></table></figure>

<h3 id="GetSurfaceAndBuiltinData"><a href="#GetSurfaceAndBuiltinData" class="headerlink" title="GetSurfaceAndBuiltinData"></a>GetSurfaceAndBuiltinData</h3><p>这个是对纹理的采样和计算。通过不同的宏，控制了纹理采样、顶点混合、视差、Lod等等内容。</p>
<p>##LitData.hlsl与LayeredLitData.hlsl</p>
<p>这两个文件中包括了纹理采样计算的主要内容：<strong>GetSurfaceAndBuiltinData函数</strong></p>
<p>重要的数据结构,根据宏来判断使用那种数据结构，记录了所有和纹理坐标相关的信息，包括Planar&#x2F;Triplanar&#x2F;Uv和多层UV，细节纹理等信息，每一层具体内容记录在：UVMapping结构中。</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">LayerTexCoord</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LAYERED_LIT_SHADER</span><br>    UVMapping base;<br>    UVMapping details;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    UVMapping base0;<br>	...<br>    UVMapping details0;<br>	...<br>    UVMapping blendMask;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    float3 vertexNormalWS; <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> store also object normal map for object triplanar</span><br>    float3 triplanarWeights;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SURFACE_GRADIENT</span><br>    float3 vertexTangentWS0, vertexBitangentWS0;.<br>    ...<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="GetSurfaceAndBuiltinData-1"><a href="#GetSurfaceAndBuiltinData-1" class="headerlink" title="GetSurfaceAndBuiltinData"></a>GetSurfaceAndBuiltinData</h3><p>这个函数主要作用是通过Frag的输入信息，计算纹理坐标。输出纹理采样和混合结果。</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">GetSurfaceAndBuiltinData</span><span class="hljs-params">(FragInputs input, float3 V, inout PositionInputs posInput, out SurfaceData surfaceData, out BuiltinData builtinData)</span><br>&#123;<br><span class="hljs-comment">// Lod CrossFade</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> LOD_FADE_CROSSFADE </span><br>    uint3 fadeMaskSeed = asuint((int3)(V * _ScreenSize.xyx)); /<br>    LODDitheringTransition(fadeMaskSeed, unity_LODFade.x);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">//双面处理</span><br>    ApplyDoubleSidedFlipOrMirror(input); <span class="hljs-comment">// Apply double sided flip on the vertex normal</span><br><span class="hljs-comment">// 根据配置计算纹理坐标：Planer、Triplanar、Tiling\offset等内容。</span><br>    LayerTexCoord layerTexCoord;<br>    ZERO_INITIALIZE(LayerTexCoord, layerTexCoord);<br>    GetLayerTexCoord(input, layerTexCoord);<br>  <br><span class="hljs-comment">// 这里是视差贴图，计算纹理偏移</span><br>    <span class="hljs-type">float</span> depthOffset = ApplyPerPixelDisplacement(input, V, layerTexCoord);<br><span class="hljs-comment">//</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _DEPTHOFFSET_ON</span><br>    ApplyDepthOffsetPositionInput(V, depthOffset, GetViewForwardDir(), GetWorldToHClipMatrix(), posInput);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-comment">// 根据计算出的纹理坐标和视差编译对纹理进行采样。</span><br>    float3 normalTS;<br>    float3 bentNormalTS;<br>    float3 bentNormalWS;<br>    <span class="hljs-type">float</span> alpha = GetSurfaceData(input, layerTexCoord, surfaceData, normalTS, bentNormalTS);<br>    GetNormalWS(input, normalTS, surfaceData.normalWS);<br><br>    <span class="hljs-comment">// Use bent normal to sample GI if available</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _BENTNORMALMAP</span><br>    GetNormalWS(input, bentNormalTS, bentNormalWS);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    bentNormalWS = surfaceData.normalWS;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    surfaceData.geomNormalWS = input.worldToTangent[<span class="hljs-number">2</span>];<br><br><span class="hljs-comment">// 从采样的结果到处高光等内容的</span><br>...<br>  <br>  <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Caution: surfaceData must be fully initialize before calling GetBuiltinData</span><br>    GetBuiltinData(input, V, posInput, surfaceData, alpha, bentNormalWS, depthOffset, builtinData);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="GetSurfaceData"><a href="#GetSurfaceData" class="headerlink" title="GetSurfaceData"></a>GetSurfaceData</h3><h3 id="GetBuiltinData"><a href="#GetBuiltinData" class="headerlink" title="GetBuiltinData"></a>GetBuiltinData</h3>
      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/4.LitShader%E5%88%86%E6%9E%90/" title="Shader代码分析">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/5.UnityHDRP%E5%85%89%E6%BA%90%E9%85%8D%E7%BD%AE/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/5.UnityHDRP%E5%85%89%E6%BA%90%E9%85%8D%E7%BD%AE/" itemprop="url">Unity光源配置：Tiled And Cluster</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="Unity光源配置：Tiled-And-Cluster"><a href="#Unity光源配置：Tiled-And-Cluster" class="headerlink" title="Unity光源配置：Tiled And Cluster"></a>Unity光源配置：Tiled And Cluster</h1><p>unity最新的HDRP中采用了Cluster和Tiled的光源配置，这里主要记录光源是如何从Unity当中的Light配置设置到最终Shader的对应Pass当中的。</p>
<p>Cluster是把视锥体看做三维体素，每个体素当中计算影响这个体素的光线，就和Volumetric Fog一样的原理。</p>
<p>Tiled是把屏幕分成格子，对每个格子计算影响这个格子的光源。</p>
<p>Tiled光照列表的计算总共分为三步：</p>
<ol>
<li>计算光照列表的所有凸包</li>
<li>使用凸包，计算bigtile的光照列表的大致计算。</li>
<li>使用fplt进行更精细的光照列表计算。</li>
</ol>
<p>##Tile光照列表计算</p>
<p>下面是光源计算,为每一个Tile生成光照列表：</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs c">public <span class="hljs-type">void</span> <span class="hljs-title function_">BuildGPULightListsCommon</span><span class="hljs-params">(HDCamera hdCamera, CommandBuffer cmd, RenderTargetIdentifier cameraDepthBufferRT, RenderTargetIdentifier stencilTextureRT, <span class="hljs-type">bool</span> skyEnabled)</span><br>&#123;<br>  var camera = hdCamera.camera;<br>  <span class="hljs-comment">// 计算光照列表开始</span><br>  cmd.BeginSample(<span class="hljs-string">&quot;Build Light List&quot;</span>);<br><br>  var w = (<span class="hljs-type">int</span>)hdCamera.screenSize.x;<br>  var h = (<span class="hljs-type">int</span>)hdCamera.screenSize.y;<br>  s_TempScreenDimArray[<span class="hljs-number">0</span>] = w;<br>  s_TempScreenDimArray[<span class="hljs-number">1</span>] = h;<br>  <span class="hljs-comment">//首先设置Tile的大小  64,64</span><br>  var numBigTilesX = (w + <span class="hljs-number">63</span>) / <span class="hljs-number">64</span>;<br>  var numBigTilesY = (h + <span class="hljs-number">63</span>) / <span class="hljs-number">64</span>;<br><br>  <br>  <span class="hljs-comment">// 计算各种矩阵：</span><br>  m_LightListProjMatrices[<span class="hljs-number">0</span>] = <br>  m_LightListProjscrMatrices[<span class="hljs-number">0</span>] = <br>  m_LightListInvProjscrMatrices[<span class="hljs-number">0</span>] =<br>  m_LightListProjHMatrices[<span class="hljs-number">0</span>] = ;<br>  m_LightListInvProjHMatrices[<span class="hljs-number">0</span>] = ；<br>     <br>  <span class="hljs-comment">// 如果有光源 ，计算所有光源的AABB包围盒 ：见shader：lightlistbuild-bigtile.compute</span><br>   <span class="hljs-keyword">if</span> (m_lightCount != <span class="hljs-number">0</span>)<br>   &#123;<br>	<span class="hljs-comment">//第一步计算AABB</span><br>     var genAABBKernel = isProjectionOblique ? s_GenAABBKernel_Oblique : s_GenAABBKernel;<br><br>     <span class="hljs-comment">// 是否正交</span><br>     cmd.SetComputeIntParam(buildScreenAABBShader, HDShaderIDs.g_isOrthographic, isOrthographic ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br>	 <span class="hljs-comment">// 光源数量</span><br>     cmd.SetComputeIntParam(buildScreenAABBShader, HDShaderIDs.g_iNrVisibLights, m_lightCount);<br>     <span class="hljs-comment">// 光源凸包数据</span><br>     cmd.SetComputeBufferParam(buildScreenAABBShader, genAABBKernel, HDShaderIDs.g_data, s_ConvexBoundsBuffer);<br>	<span class="hljs-comment">// 矩阵数组</span><br>     cmd.SetComputeMatrixArrayParam(buildScreenAABBShader, HDShaderIDs.g_mProjectionArr, m_LightListProjHMatrices);<br>     cmd.SetComputeMatrixArrayParam(buildScreenAABBShader, HDShaderIDs.g_mInvProjectionArr, m_LightListInvProjHMatrices);<br><br>     <span class="hljs-comment">// AABB结果</span><br>     cmd.SetComputeBufferParam(buildScreenAABBShader, genAABBKernel, HDShaderIDs.g_vBoundsBuffer, s_AABBBoundsBuffer);<br><br>     <span class="hljs-type">int</span> tgY = (<span class="hljs-type">int</span>)hdCamera.numEyes;<br>     <br>     <span class="hljs-comment">// 提交计算</span><br>     cmd.DispatchCompute(buildScreenAABBShader, genAABBKernel, (m_lightCount + <span class="hljs-number">7</span>) / <span class="hljs-number">8</span>, tgY, <span class="hljs-number">1</span>);<br>   &#125;<br>  <br>  <br>  <span class="hljs-comment">// 粗糙的Tile计算。</span><br>  <span class="hljs-comment">// enable coarse 2D pass on 64x64 tiles (used for both fptl and clustered).</span><br>  <span class="hljs-keyword">if</span> (m_FrameSettings.lightLoopSettings.enableBigTilePrepass)<br>  &#123;<br>    cmd.SetComputeIntParam(buildPerBigTileLightListShader, HDShaderIDs.g_iNrVisibLights, m_lightCount);<br>    cmd.SetComputeIntParam(buildPerBigTileLightListShader, HDShaderIDs.g_isOrthographic, isOrthographic ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br>    cmd.SetComputeIntParams(buildPerBigTileLightListShader, HDShaderIDs.g_viDimensions, s_TempScreenDimArray);<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> These two aren&#x27;t actually used...</span><br>    cmd.SetComputeIntParam(buildPerBigTileLightListShader, HDShaderIDs._EnvLightIndexShift, m_lightList.lights.Count);<br>    cmd.SetComputeIntParam(buildPerBigTileLightListShader, HDShaderIDs._DecalIndexShift, m_lightList.lights.Count + m_lightList.envLights.Count);<br><br>    cmd.SetComputeMatrixArrayParam(buildPerBigTileLightListShader, HDShaderIDs.g_mScrProjectionArr, m_LightListProjscrMatrices);<br>    cmd.SetComputeMatrixArrayParam(buildPerBigTileLightListShader, HDShaderIDs.g_mInvScrProjectionArr, m_LightListInvProjscrMatrices);<br><br>    cmd.SetComputeFloatParam(buildPerBigTileLightListShader, HDShaderIDs.g_fNearPlane, camera.nearClipPlane);<br>    cmd.SetComputeFloatParam(buildPerBigTileLightListShader, HDShaderIDs.g_fFarPlane, camera.farClipPlane);<br>    cmd.SetComputeBufferParam(buildPerBigTileLightListShader, s_GenListPerBigTileKernel, HDShaderIDs.g_vLightList, s_BigTileLightList);<br>    cmd.SetComputeBufferParam(buildPerBigTileLightListShader, s_GenListPerBigTileKernel, HDShaderIDs.g_vBoundsBuffer, s_AABBBoundsBuffer);<br>    cmd.SetComputeBufferParam(buildPerBigTileLightListShader, s_GenListPerBigTileKernel, HDShaderIDs._LightVolumeData, s_LightVolumeDataBuffer);<br>    cmd.SetComputeBufferParam(buildPerBigTileLightListShader, s_GenListPerBigTileKernel, HDShaderIDs.g_data, s_ConvexBoundsBuffer);<br><br>    <span class="hljs-type">int</span> tgZ = (<span class="hljs-type">int</span>)hdCamera.numEyes;<br>    cmd.DispatchCompute(buildPerBigTileLightListShader, s_GenListPerBigTileKernel, numBigTilesX, numBigTilesY, tgZ);<br>  &#125;<br>  <br>  <br>  <span class="hljs-comment">// fplt计算</span><br>  <span class="hljs-comment">// optimized for opaques only</span><br>    <span class="hljs-keyword">if</span> (m_FrameSettings.lightLoopSettings.isFptlEnabled)<br>    &#123;<br>      var genListPerTileKernel = isProjectionOblique ? s_GenListPerTileKernel_Oblique : s_GenListPerTileKernel;<br><br>      cmd.SetComputeIntParam(buildPerTileLightListShader, HDShaderIDs.g_isOrthographic, isOrthographic ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br>      cmd.SetComputeIntParams(buildPerTileLightListShader, HDShaderIDs.g_viDimensions, s_TempScreenDimArray);<br>      cmd.SetComputeIntParam(buildPerTileLightListShader, HDShaderIDs._EnvLightIndexShift, m_lightList.lights.Count);<br>      cmd.SetComputeIntParam(buildPerTileLightListShader, HDShaderIDs._DecalIndexShift, m_lightList.lights.Count + m_lightList.envLights.Count);<br>      cmd.SetComputeIntParam(buildPerTileLightListShader, HDShaderIDs.g_iNrVisibLights, m_lightCount);<br><br>      cmd.SetComputeBufferParam(buildPerTileLightListShader, genListPerTileKernel, HDShaderIDs.g_vBoundsBuffer, s_AABBBoundsBuffer);<br>      cmd.SetComputeBufferParam(buildPerTileLightListShader, genListPerTileKernel, HDShaderIDs._LightVolumeData, s_LightVolumeDataBuffer);<br>      cmd.SetComputeBufferParam(buildPerTileLightListShader, genListPerTileKernel, HDShaderIDs.g_data, s_ConvexBoundsBuffer);<br><br>      cmd.SetComputeMatrixParam(buildPerTileLightListShader, HDShaderIDs.g_mScrProjection, m_LightListProjscrMatrices[<span class="hljs-number">0</span>]);<br>      cmd.SetComputeMatrixParam(buildPerTileLightListShader, HDShaderIDs.g_mInvScrProjection, m_LightListInvProjscrMatrices[<span class="hljs-number">0</span>]);<br><br>      cmd.SetComputeTextureParam(buildPerTileLightListShader, genListPerTileKernel, HDShaderIDs.g_depth_tex, cameraDepthBufferRT);<br>      cmd.SetComputeBufferParam(buildPerTileLightListShader, genListPerTileKernel, HDShaderIDs.g_vLightList, s_LightList);<br>      <span class="hljs-keyword">if</span> (m_FrameSettings.lightLoopSettings.enableBigTilePrepass)<br>        cmd.SetComputeBufferParam(buildPerTileLightListShader, genListPerTileKernel, HDShaderIDs.g_vBigTileLightList, s_BigTileLightList);<br><br>      <span class="hljs-keyword">if</span> (enableFeatureVariants)<br>      &#123;<br>        uint baseFeatureFlags = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (m_lightList.directionalLights.Count &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>          baseFeatureFlags |= (uint)LightFeatureFlags.Directional;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (skyEnabled)<br>        &#123;<br>          baseFeatureFlags |= (uint)LightFeatureFlags.Sky;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!m_FrameSettings.lightLoopSettings.enableComputeMaterialVariants)<br>        &#123;<br>          baseFeatureFlags |= LightDefinitions.s_MaterialFeatureMaskFlags;<br>        &#125;<br>        cmd.SetComputeIntParam(buildPerTileLightListShader, HDShaderIDs.g_BaseFeatureFlags, (<span class="hljs-type">int</span>)baseFeatureFlags);<br>        cmd.SetComputeBufferParam(buildPerTileLightListShader, genListPerTileKernel, HDShaderIDs.g_TileFeatureFlags, s_TileFeatureFlags);<br>      &#125;<br><br>      cmd.DispatchCompute(buildPerTileLightListShader, genListPerTileKernel, numTilesX, numTilesY, <span class="hljs-number">1</span>);<br>    &#125;<br>  <br>  <span class="hljs-comment">// Cluster 计算</span><br>  VoxelLightListGeneration(cmd, hdCamera, m_LightListProjscrMatrices, m_LightListInvProjscrMatrices, cameraDepthBufferRT);<br><br>  <span class="hljs-comment">// 计算光照列表结束</span><br>  cmd.EndSample(<span class="hljs-string">&quot;Build Light List&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="光源包围盒计算"><a href="#光源包围盒计算" class="headerlink" title="光源包围盒计算"></a>光源包围盒计算</h3><p>计算屏幕空间光源包围盒的shader：scrbound.compute</p>
<p>原始代码中记录的包围盒的类型，中心和几个扩展方向</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">public <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SFiniteLightBound</span></span><br><span class="hljs-class">&#123;</span><br>    public Vector3 boxAxisX;<br>    public Vector3 boxAxisY;<br>    public Vector3 boxAxisZ;<br>    public Vector3 center;        <span class="hljs-comment">// a center in camera space inside the bounding volume of the light source.</span><br>    public Vector2 scaleXY;<br>    public <span class="hljs-type">float</span> radius;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>每个光源都有一个上面的结构体，从一个统一的结构体转换到屏幕对齐的AABB包围盒。</p>
<p>###BigTile光照列表计算</p>
<p>计算BigTile光照列表的compute shader：</p>
<p>使用了三种方法：</p>
<ol>
<li>包围盒相交。</li>
<li>球形相交。</li>
<li>CullByExactEdgeTests：这个还没有看。</li>
</ol>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 根据NR_THREADS作为不同线程的采样间隔，计算互斥的光源信息</span><br>[numthreads(NR_THREADS, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)]<br><span class="hljs-type">void</span> <span class="hljs-title function_">BigTileLightListGen</span><span class="hljs-params">(uint threadID : SV_GroupIndex, uint3 u3GroupID : SV_GroupID)</span><br>&#123;<br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">  这里的计算是每个Tile一次提交，每个提交，多个Thread并行。，每个Thread处理不想交的一组灯光。</span><br><span class="hljs-comment">  */</span><br>  	<span class="hljs-comment">// 这个是Tile的ID</span><br>    uint eyeIndex = u3GroupID.z;<br>    uint2 tileIDX = u3GroupID.xy;<br>  	<span class="hljs-comment">//  这个是每个Tile当中的threadID</span><br>    uint t=threadID;<br>  <br>	<span class="hljs-comment">// 计算每个Tile的实际大小。</span><br>    uint iWidth = g_viDimensions.x;<br>    uint iHeight = g_viDimensions.y;<br>    uint nrBigTilesX = (iWidth+<span class="hljs-number">63</span>)/<span class="hljs-number">64</span>;<br>    uint nrBigTilesY = (iHeight+<span class="hljs-number">63</span>)/<span class="hljs-number">64</span>;<br>	<br>  <span class="hljs-comment">// 线程共享，只让第一个线程进行初始化操作。</span><br>    <span class="hljs-keyword">if</span>(t==<span class="hljs-number">0</span>) lightOffs = <span class="hljs-number">0</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(SHADER_API_XBOXONE) &amp;&amp; !defined(SHADER_API_PSSL)</span><br>    GroupMemoryBarrierWithGroupSync();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// Raw pixel coordinates of tile</span><br>    uint2 viTilLL = <span class="hljs-number">64</span>*tileIDX;<br>    uint2 viTilUR = min( viTilLL+uint2(<span class="hljs-number">64</span>,<span class="hljs-number">64</span>), uint2(iWidth, iHeight) );            <span class="hljs-comment">// not width and height minus 1 since viTilUR represents the end of the tile corner.</span><br><br>    <span class="hljs-comment">// 每个tile的包围盒</span><br>    float2 vTileLL = float2(viTilLL.x/(<span class="hljs-type">float</span>) iWidth, viTilLL.y/(<span class="hljs-type">float</span>) iHeight);<br>    float2 vTileUR = float2(viTilUR.x/(<span class="hljs-type">float</span>) iWidth, viTilUR.y/(<span class="hljs-type">float</span>) iHeight);<br><br>    <span class="hljs-comment">// build coarse list using AABB</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> l=(<span class="hljs-type">int</span>) t; l&lt;(<span class="hljs-type">int</span>) g_iNrVisibLights; l += NR_THREADS)<br>    &#123;<br>      	<span class="hljs-comment">// 获取灯光包围盒信息</span><br>        <span class="hljs-type">const</span> ScreenSpaceBoundsIndices boundsIndices = GenerateScreenSpaceBoundsIndices(l, g_iNrVisibLights, eyeIndex);<br>      	<span class="hljs-comment">// 灯光的包围盒信息</span><br>        <span class="hljs-type">const</span> float2 vMi = g_vBoundsBuffer[boundsIndices.min].xy;<br>        <span class="hljs-type">const</span> float2 vMa = g_vBoundsBuffer[boundsIndices.max].xy;<br>		<br>  	    <span class="hljs-comment">// 灯光的包围盒和tile的包围盒是否相交</span><br>        <span class="hljs-keyword">if</span>( all(vMa&gt;vTileLL) &amp;&amp; all(vMi&lt;vTileUR))<br>        &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> uInc = <span class="hljs-number">1</span>;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> uIndex;<br>          	<span class="hljs-comment">// 原子求和操作，让lightOffs加1.</span><br>            InterlockedAdd(lightOffs, uInc, uIndex);<br>			<span class="hljs-comment">// 通过加到当前Tile的灯光列表，uIndex是组间不同的。</span><br>            <span class="hljs-keyword">if</span>(uIndex&lt;MAX_NR_BIGTILE_LIGHTS) lightsListLDS[uIndex] = l;    <br>        &#125;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> <span class="hljs-comment">/*!defined(SHADER_API_XBOXONE) &amp;&amp; */</span>!defined(SHADER_API_PSSL)</span><br>    GroupMemoryBarrierWithGroupSync();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  	<span class="hljs-comment">// 计算实际的光照数。</span><br>    <span class="hljs-type">int</span> iNrCoarseLights = min(lightOffs,MAX_NR_BIGTILE_LIGHTS);<br><br>  <span class="hljs-comment">// 球形相交计算，如果球形没有相交， 则把lightlist中记录原来相交的id变成uint_max</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PERFORM_SPHERICAL_INTERSECTION_TESTS</span><br>    SphericalIntersectionTests( t, iNrCoarseLights, float2(min(viTilLL.xy+uint2(<span class="hljs-number">64</span>/<span class="hljs-number">2</span>,<span class="hljs-number">64</span>/<span class="hljs-number">2</span>), uint2(iWidth<span class="hljs-number">-1</span>, iHeight<span class="hljs-number">-1</span>))), eyeIndex );<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> EXACT_EDGE_TESTS</span><br>    CullByExactEdgeTests(t, iNrCoarseLights, viTilLL.xy, viTilUR.xy, eyeIndex);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// 灯光按类型排序</span><br>    SORTLIST(lightsListLDS, iNrCoarseLights, MAX_NR_BIG_TILE_LIGHTS_PLUS_ONE, t, NR_THREADS);<br><br>    <span class="hljs-keyword">if</span>(t==<span class="hljs-number">0</span>) lightOffs = <span class="hljs-number">0</span>;<br>    GroupMemoryBarrierWithGroupSync();<br>  <span class="hljs-comment">// 重新计算光照数量</span><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i=t; i&lt;iNrCoarseLights; i+=NR_THREADS) <br>      <span class="hljs-keyword">if</span>(lightsListLDS[i]&lt;(uint)g_iNrVisibLights) <br>        InterlockedAdd(lightOffs, <span class="hljs-number">1</span>);<br>    GroupMemoryBarrierWithGroupSync();<br>    iNrCoarseLights = lightOffs;<br><span class="hljs-comment">// 计算当前tile的索引</span><br>    <span class="hljs-type">int</span> offs = tileIDX.y*nrBigTilesX + tileIDX.x + (eyeIndex * nrBigTilesX * nrBigTilesY);<br>	<span class="hljs-comment">//最终的光照列表，放到记录光照的列表当中，所有的tile的光照列表存在一个大的tile当中。</span><br>    <span class="hljs-keyword">for</span>(i=t; i&lt;(iNrCoarseLights+<span class="hljs-number">1</span>); i+=NR_THREADS)<br>        g_vLightList[MAX_NR_BIG_TILE_LIGHTS_PLUS_ONE*offs + i] = i==<span class="hljs-number">0</span> ? iNrCoarseLights : lightsListLDS[max(i<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>)];<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="FPTL"><a href="#FPTL" class="headerlink" title="FPTL"></a>FPTL</h3><p>精准的判断每个tile当中的光照列表,这里使用了更加精细的tile划分（16*16），相对于bigtile还会对Z值进行比较。原本的Bigtile 只是用了屏幕方向的xy。</p>
<p>同时加入了光源类型相关的操作。</p>
<p>shader使用:lightlistbuild.compute</p>
<p>compute Shader使用的kernel确定：</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (GetFeatureVariantsEnabled())<br>&#123;<br>  s_GenListPerTileKernel = buildPerTileLightListShader.FindKernel(m_FrameSettings.lightLoopSettings.enableBigTilePrepass ? <span class="hljs-string">&quot;TileLightListGen_SrcBigTile_FeatureFlags&quot;</span> : <span class="hljs-string">&quot;TileLightListGen_FeatureFlags&quot;</span>);<br>  s_GenListPerTileKernel_Oblique = buildPerTileLightListShader.FindKernel(m_FrameSettings.lightLoopSettings.enableBigTilePrepass ? <span class="hljs-string">&quot;TileLightListGen_SrcBigTile_FeatureFlags_Oblique&quot;</span> : <span class="hljs-string">&quot;TileLightListGen_FeatureFlags_Oblique&quot;</span>);<br><br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  s_GenListPerTileKernel = buildPerTileLightListShader.FindKernel(m_FrameSettings.lightLoopSettings.enableBigTilePrepass ? <span class="hljs-string">&quot;TileLightListGen_SrcBigTile&quot;</span> : <span class="hljs-string">&quot;TileLightListGen&quot;</span>);<br>  s_GenListPerTileKernel_Oblique = buildPerTileLightListShader.FindKernel(m_FrameSettings.lightLoopSettings.enableBigTilePrepass ? <span class="hljs-string">&quot;TileLightListGen_SrcBigTile_Oblique&quot;</span> : <span class="hljs-string">&quot;TileLightListGen_Oblique&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>FPTLshader</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs c">[numthreads(NR_THREADS, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)]<br><span class="hljs-type">void</span> <span class="hljs-title function_">LIGHTLISTGEN</span><span class="hljs-params">(uint threadID : SV_GroupIndex, uint3 u3GroupID : SV_GroupID)</span><br>&#123;<br>    uint2 tileIDX = u3GroupID.xy;<br>    uint t=threadID;<br><br>    <span class="hljs-keyword">if</span>(t&lt;MAX_NR_COARSE_ENTRIES)<br>        prunedList[t]=<span class="hljs-number">0</span>;<br><br>    uint iWidth = g_viDimensions.x;<br>    uint iHeight = g_viDimensions.y;<br>    uint nrTilesX = (iWidth+<span class="hljs-number">15</span>)/<span class="hljs-number">16</span>;<br>    uint nrTilesY = (iHeight+<span class="hljs-number">15</span>)/<span class="hljs-number">16</span>;<br>    uint nrTiles = nrTilesX * nrTilesY; <span class="hljs-comment">// Precompute?</span><br><br>    <span class="hljs-comment">// build tile scr boundary</span><br>    <span class="hljs-type">const</span> uint uFltMax = <span class="hljs-number">0x7f7fffff</span>;  <span class="hljs-comment">// FLT_MAX as a uint</span><br>    <span class="hljs-keyword">if</span>(t==<span class="hljs-number">0</span>)<br>    &#123;<br>        ldsZMin = uFltMax;<br>        ldsZMax = <span class="hljs-number">0</span>;<br>        lightOffs = <span class="hljs-number">0</span>;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(SHADER_API_XBOXONE) &amp;&amp; !defined(SHADER_API_PSSL)</span><br>    GroupMemoryBarrierWithGroupSync();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    uint2 viTilLL = <span class="hljs-number">16</span>*tileIDX;<br><br>    <span class="hljs-comment">// establish min and max depth first</span><br>    <span class="hljs-type">float</span> dpt_mi=asfloat(uFltMax), dpt_ma=<span class="hljs-number">0.0</span>;<br>	<span class="hljs-comment">// 计算包含深度的包围盒。</span><br>    float4 vLinDepths;<br>    &#123;<br>        <span class="hljs-comment">// Fetch depths and calculate min/max</span><br>        UNITY_UNROLL<br>        <span class="hljs-title function_">for</span><span class="hljs-params">(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)</span><br>        &#123;<br>            <span class="hljs-type">int</span> idx = i * NR_THREADS + t;<br>            uint2 uCrd = min( uint2(viTilLL.x+(idx&amp;<span class="hljs-number">0xf</span>), viTilLL.y+(idx&gt;&gt;<span class="hljs-number">4</span>)), uint2(iWidth<span class="hljs-number">-1</span>, iHeight<span class="hljs-number">-1</span>) );<br>            <span class="hljs-type">const</span> <span class="hljs-type">float</span> fDepth = FetchDepth(g_depth_tex, uCrd);<br>            vLinDepths[i] = GetLinearDepth(uCrd+float2(<span class="hljs-number">0.5</span>,<span class="hljs-number">0.5</span>), fDepth);<br>            <span class="hljs-keyword">if</span>(fDepth&lt;VIEWPORT_SCALE_Z)     <span class="hljs-comment">// if not skydome</span><br>            &#123;<br>                dpt_mi = min(fDepth, dpt_mi);<br>                dpt_ma = max(fDepth, dpt_ma);<br>            &#125;<br>        &#125;<br><br>        InterlockedMax(ldsZMax, asuint(dpt_ma));<br>        InterlockedMin(ldsZMin, asuint(dpt_mi));<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(SHADER_API_XBOXONE) &amp;&amp; !defined(SHADER_API_PSSL)</span><br>        GroupMemoryBarrierWithGroupSync();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br><br><br>    float3 vTileLL = float3(viTilLL.x/(<span class="hljs-type">float</span>) iWidth, viTilLL.y/(<span class="hljs-type">float</span>) iHeight, asfloat(ldsZMin));<br>    float3 vTileUR = float3((viTilLL.x+<span class="hljs-number">16</span>)/(<span class="hljs-type">float</span>) iWidth, (viTilLL.y+<span class="hljs-number">16</span>)/(<span class="hljs-type">float</span>) iHeight, asfloat(ldsZMax));<br>    vTileUR.xy = min(vTileUR.xy,float2(<span class="hljs-number">1.0</span>,<span class="hljs-number">1.0</span>)).xy;<br><br>	<span class="hljs-comment">// 使用aabb计算粗糙的光照列表。</span><br>    <span class="hljs-comment">// build coarse list using AABB</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> USE_TWO_PASS_TILED_LIGHTING</span><br>    <span class="hljs-type">const</span> uint log2BigTileToTileRatio = firstbithigh(<span class="hljs-number">64</span>) - firstbithigh(<span class="hljs-number">16</span>);<br><br>    <span class="hljs-type">int</span> NrBigTilesX = (nrTilesX+((<span class="hljs-number">1</span>&lt;&lt;log2BigTileToTileRatio)<span class="hljs-number">-1</span>))&gt;&gt;log2BigTileToTileRatio;<br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> bigTileIdx = (tileIDX.y&gt;&gt;log2BigTileToTileRatio)*NrBigTilesX + (tileIDX.x&gt;&gt;log2BigTileToTileRatio);       <span class="hljs-comment">// map the idx to 64x64 tiles</span><br>    <span class="hljs-type">int</span> nrBigTileLights = g_vBigTileLightList[MAX_NR_BIG_TILE_LIGHTS_PLUS_ONE*bigTileIdx+<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> l0=(<span class="hljs-type">int</span>) t; l0&lt;(<span class="hljs-type">int</span>) nrBigTileLights; l0 += NR_THREADS)<br>    &#123;<br>        <span class="hljs-type">int</span> l = g_vBigTileLightList[MAX_NR_BIG_TILE_LIGHTS_PLUS_ONE*bigTileIdx+l0+<span class="hljs-number">1</span>];<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> l=(<span class="hljs-type">int</span>) t; l&lt;(<span class="hljs-type">int</span>) g_iNrVisibLights; l += NR_THREADS)<br>    &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>        <span class="hljs-comment">// Skip density volumes (lights are sorted by category). <span class="hljs-doctag">TODO:</span> improve data locality</span><br>        <span class="hljs-keyword">if</span> (_LightVolumeData[l].lightCategory == LIGHTCATEGORY_DENSITY_VOLUME) &#123; <span class="hljs-keyword">break</span>; &#125;<br><br>        <span class="hljs-type">const</span> float3 vMi = g_vBoundsBuffer[l].xyz;<br>        <span class="hljs-type">const</span> float3 vMa = g_vBoundsBuffer[l+g_iNrVisibLights].xyz;<br>		<span class="hljs-comment">// 包围盒在xyz方向上同时判断相交。</span><br>        <span class="hljs-keyword">if</span>( all(vMa&gt;vTileLL) &amp;&amp; all(vMi&lt;vTileUR))<br>        &#123;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> uInc = <span class="hljs-number">1</span>;<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> uIndex;<br>            InterlockedAdd(lightOffs, uInc, uIndex);<br>            <span class="hljs-keyword">if</span>(uIndex&lt;MAX_NR_COARSE_ENTRIES) coarseList[uIndex] = l;        <span class="hljs-comment">// add to light list</span><br>        &#125;<br>    &#125;<br>      <span class="hljs-comment">// 粗糙的光照列表计算结束</span><br><br>      <span class="hljs-comment">// FPTL进行精细调整。</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> FINE_PRUNING_ENABLED</span><br>    <span class="hljs-keyword">if</span>(t&lt;<span class="hljs-number">2</span>) ldsDoesLightIntersect[t] = <span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(SHADER_API_XBOXONE) &amp;&amp; !defined(SHADER_API_PSSL)</span><br>    GroupMemoryBarrierWithGroupSync();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<br>    <span class="hljs-type">int</span> iNrCoarseLights = min(lightOffs,MAX_NR_COARSE_ENTRIES);<br><br>      <span class="hljs-comment">// 球形相交和 bigtile类似</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PERFORM_SPHERICAL_INTERSECTION_TESTS</span><br>    iNrCoarseLights = SphericalIntersectionTests( t, iNrCoarseLights, float2(min(viTilLL.xy+uint2(<span class="hljs-number">16</span>/<span class="hljs-number">2</span>,<span class="hljs-number">16</span>/<span class="hljs-number">2</span>), uint2(iWidth<span class="hljs-number">-1</span>, iHeight<span class="hljs-number">-1</span>))) );<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> FINE_PRUNING_ENABLED</span><br>    &#123;<br>      <span class="hljs-comment">// 修改保存位置</span><br>        <span class="hljs-keyword">if</span>((<span class="hljs-type">int</span>)t&lt;iNrCoarseLights) prunedList[t] = coarseList[t];<br>        <span class="hljs-keyword">if</span>(t==<span class="hljs-number">0</span>) ldsNrLightsFinal=iNrCoarseLights;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    &#123;<br>        <span class="hljs-comment">// initializes ldsNrLightsFinal with the number of accepted lights.</span><br>        <span class="hljs-comment">// all accepted entries delivered in prunedList[].</span><br>        FinePruneLights(t, iNrCoarseLights, viTilLL, vLinDepths);<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-comment">// 光照类型相关，t是线程号。每个线程对应一个类型。</span><br>    <span class="hljs-keyword">if</span>(t&lt;CATEGORY_LIST_SIZE) ldsCategoryListCount[t]=<span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> USE_FEATURE_FLAGS</span><br>    <span class="hljs-keyword">if</span>(t==<span class="hljs-number">0</span>) ldsFeatureFlags=<span class="hljs-number">0</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(SHADER_API_XBOXONE) &amp;&amp; !defined(SHADER_API_PSSL)</span><br>    GroupMemoryBarrierWithGroupSync();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><br>     <span class="hljs-comment">// 统计每种类型光源的数量</span><br>    <span class="hljs-type">int</span> nrLightsCombinedList = min(ldsNrLightsFinal,MAX_NR_COARSE_ENTRIES);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=t; i&lt;nrLightsCombinedList; i+=NR_THREADS)<br>    &#123;<br>        InterlockedAdd(ldsCategoryListCount[_LightVolumeData[prunedList[i]].lightCategory], <span class="hljs-number">1</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> USE_FEATURE_FLAGS</span><br>        InterlockedOr(ldsFeatureFlags, _LightVolumeData[prunedList[i]].featureFlags);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br><br>      <span class="hljs-comment">// 光照排序，减少在计算光照过程中分支的情况</span><br>    <span class="hljs-comment">// sort lights (gives a more efficient execution in both deferred and tiled forward lighting).</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> !defined(SHADER_API_XBOXONE) &amp;&amp; !defined(SHADER_API_PSSL)</span><br>    SORTLIST(prunedList, nrLightsCombinedList, MAX_NR_COARSE_ENTRIES, t, NR_THREADS);<br>    <span class="hljs-comment">//MERGESORTLIST(prunedList, coarseList, nrLightsCombinedList, t, NR_THREADS);</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> USE_FEATURE_FLAGS</span><br>    <span class="hljs-keyword">if</span>(t == <span class="hljs-number">0</span>)<br>    &#123;<br>        uint featureFlags = ldsFeatureFlags | g_BaseFeatureFlags;<br>        <span class="hljs-comment">// In case of back</span><br>        <span class="hljs-keyword">if</span>(ldsZMax &lt; ldsZMin)   <span class="hljs-comment">// is background pixel</span><br>        &#123;<br>            <span class="hljs-comment">// There is no stencil usage with compute path, featureFlags set to 0 is use to have fast rejection of tile in this case. It will still execute but will do nothing</span><br>            featureFlags = <span class="hljs-number">0</span>;<br>        &#125;<br><br>        g_TileFeatureFlags[tileIDX.y * nrTilesX + tileIDX.x] = featureFlags;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>    <span class="hljs-comment">// write lights to global buffers</span><br>    <span class="hljs-type">int</span> localOffs=<span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> offs = tileIDX.y*nrTilesX + tileIDX.x;<br><br>    <span class="hljs-comment">// All our cull data are in the same list, but at render time envLights are separated so we need to shift the index</span><br>    <span class="hljs-comment">// to make it work correctly</span><br>    <span class="hljs-type">int</span> shiftIndex[CATEGORY_LIST_SIZE];<br>    ZERO_INITIALIZE_ARRAY(<span class="hljs-type">int</span>, shiftIndex, CATEGORY_LIST_SIZE);<br>    shiftIndex[CATEGORY_LIST_SIZE - <span class="hljs-number">2</span>] = _EnvLightIndexShift;<br>    shiftIndex[CATEGORY_LIST_SIZE - <span class="hljs-number">1</span>] = _DecalIndexShift;<br>	<br>      <span class="hljs-comment">//将光源按照类型顺序写入到全局结果中。</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> category=<span class="hljs-number">0</span>; category&lt;CATEGORY_LIST_SIZE; category++)<br>    &#123;<br>        <span class="hljs-type">int</span> nrLightsFinal = ldsCategoryListCount[category];<br>        <span class="hljs-type">int</span> nrLightsFinalClamped = nrLightsFinal&lt;MAX_NR_PRUNED_ENTRIES ? nrLightsFinal : MAX_NR_PRUNED_ENTRIES;<br><br>        <span class="hljs-type">const</span> <span class="hljs-type">int</span> nrDWords = ((nrLightsFinalClamped+<span class="hljs-number">1</span>)+<span class="hljs-number">1</span>)&gt;&gt;<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> l=(<span class="hljs-type">int</span>) t; l&lt;(<span class="hljs-type">int</span>) nrDWords; l += NR_THREADS)<br>        &#123;<br>            <span class="hljs-comment">// We remap the prunedList index to the original LightData / EnvLightData indices</span><br>            uint uLow = l==<span class="hljs-number">0</span> ? nrLightsFinalClamped : prunedList[max(<span class="hljs-number">0</span>,<span class="hljs-number">2</span> * l - <span class="hljs-number">1</span> + localOffs)] - shiftIndex[category];<br>            uint uHigh = prunedList[<span class="hljs-number">2</span> * l + <span class="hljs-number">0</span> + localOffs] - shiftIndex[category];<br><br>            g_vLightList[<span class="hljs-number">16</span>*offs + l] = (uLow&amp;<span class="hljs-number">0xffff</span>) | (uHigh&lt;&lt;<span class="hljs-number">16</span>);<br>        &#125;<br><br>        localOffs += nrLightsFinal;<br>        offs += (nrTilesX*nrTilesY);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/5.UnityHDRP%E5%85%89%E6%BA%90%E9%85%8D%E7%BD%AE/" title="Unity光源配置：Tiled And Cluster">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/6.HDRPDecal/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/6.HDRPDecal/" itemprop="url">HDRP Decal</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <p>#HDRP Decal</p>
<p>Unity提供了贴花功能，现在能够控制Decal具体要投射到哪些物体上。。</p>
<p>Decal 渲染最开始需要一个深度图：</p>
<p>需要透视Decal的物体会渲染</p>
<p>m_DepthOnlyPassNames ：渲染深度</p>
<p>m_DepthForwardOnlyPassNames：渲染法线</p>
<p>Decal需要进行可以进行异步剪裁</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableDecals)<br>&#123;<br>  <span class="hljs-comment">// decal system needs to be updated with current camera, it needs it to set up culling and light list generation parameters</span><br>  DecalSystem.instance.CurrentCamera = camera;<br>  DecalSystem.instance.BeginCull();<br>&#125;<br><br><span class="hljs-comment">// 其他计算。</span><br><br>m_DbufferManager.enableDecals = <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">if</span> (hdCamera.frameSettings.enableDecals)<br>&#123;<br>  using (new ProfilingSample(cmd, <span class="hljs-string">&quot;DBufferPrepareDrawData&quot;</span>, CustomSamplerId.DBufferPrepareDrawData.GetSampler()))<br>  &#123;<br>    DecalSystem.instance.EndCull();<br>    m_DbufferManager.enableDecals = <span class="hljs-literal">true</span>;              <span class="hljs-comment">// mesh decals are renderers managed by c++ runtime and we have no way to query if any are visible, so set to true</span><br>    DecalSystem.instance.UpdateCachedMaterialData();    <span class="hljs-comment">// textures, alpha or fade distances could&#x27;ve changed</span><br>    DecalSystem.instance.CreateDrawData();              <span class="hljs-comment">// prepare data is separate from draw</span><br>    DecalSystem.instance.UpdateTextureAtlas(cmd);       <span class="hljs-comment">// as this is only used for transparent pass, would&#x27;ve been nice not to have to do this if no transparent renderers are visible, needs to happen after CreateDrawData</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="关于Dbuffer"><a href="#关于Dbuffer" class="headerlink" title="关于Dbuffer"></a>关于Dbuffer</h2><p>如果没有Decals 则不需要Dbuffer，Decal是需要渲染到Dbuffer当中的，Dbuffer的结构类似Gbuffer.</p>
<p>下面是Dbuffer渲染代码：</p>
<figure class="hljs highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">RenderDBuffer</span><span class="hljs-params">(HDCamera hdCamera, CommandBuffer cmd, ScriptableRenderContext renderContext, CullResults cullResults)</span><br>&#123;<br>  <span class="hljs-comment">// 不需要Decals 则不需要Dbuffer</span><br>  <span class="hljs-keyword">if</span> (!hdCamera.frameSettings.enableDecals)<br>    <span class="hljs-keyword">return</span>;<br><br><br>	<span class="hljs-comment">// 深度信息 放入Depth Buffer（从 m_SharedRTManager.GetDepthStencilBuffer() =&gt; m_SharedRTManager.GetDepthTexture()）</span><br>    CopyDepthBufferIfNeeded(cmd);<br><br>    <span class="hljs-type">bool</span> rtCount4 = m_Asset.GetRenderPipelineSettings().decalSettings.perChannelMask;<br>    <span class="hljs-comment">// Depth texture is now ready, bind it.</span><br>  <span class="hljs-comment">// 设置全局纹理</span><br>    cmd.SetGlobalTexture(HDShaderIDs._CameraDepthTexture, m_SharedRTManager.GetDepthTexture());<br>  <span class="hljs-comment">// 清理纹理设置成渲染目标，内部这只了多个渲染目标，m_SharedRTManager.GetDepthStencilBuffer()只是指定了深度用哪一个。</span><br>    m_DbufferManager.ClearAndSetTargets(cmd, hdCamera, rtCount4, m_SharedRTManager.GetDepthStencilBuffer());<br>    renderContext.ExecuteCommandBuffer(cmd);<br>  <br>  <span class="hljs-comment">// 这里cmd重置了</span><br>    cmd.Clear();<br><br>    DrawRendererSettings drawSettings = new DrawRendererSettings(hdCamera.camera, HDShaderPassNames.s_EmptyName)<br>    &#123;<br>      rendererConfiguration = <span class="hljs-number">0</span>,<br>      sorting = &#123; flags = SortFlags.CommonOpaque &#125;<br>    &#125;;<br><br>  <span class="hljs-comment">// 渲染目标数量 决定渲染方式，即需要绘制的pass名字</span><br>    <span class="hljs-keyword">if</span> (rtCount4)<br>    &#123;<br>      drawSettings.SetShaderPassName(<span class="hljs-number">0</span>, HDShaderPassNames.s_MeshDecalsMName);<br>      drawSettings.SetShaderPassName(<span class="hljs-number">1</span>, HDShaderPassNames.s_MeshDecalsAOName);<br>      drawSettings.SetShaderPassName(<span class="hljs-number">2</span>, HDShaderPassNames.s_MeshDecalsMAOName);<br>      drawSettings.SetShaderPassName(<span class="hljs-number">3</span>, HDShaderPassNames.s_MeshDecalsSName);<br>      drawSettings.SetShaderPassName(<span class="hljs-number">4</span>, HDShaderPassNames.s_MeshDecalsMSName);<br>      drawSettings.SetShaderPassName(<span class="hljs-number">5</span>, HDShaderPassNames.s_MeshDecalsAOSName);<br>      drawSettings.SetShaderPassName(<span class="hljs-number">6</span>, HDShaderPassNames.s_MeshDecalsMAOSName);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      drawSettings.SetShaderPassName(<span class="hljs-number">0</span>, HDShaderPassNames.s_MeshDecals3RTName);<br>    &#125;<br><br>  <span class="hljs-comment">// 所有不透明物体</span><br>    FilterRenderersSettings filterRenderersSettings = new FilterRenderersSettings(<span class="hljs-literal">true</span>)<br>    &#123;<br>      renderQueueRange = HDRenderQueue.k_RenderQueue_AllOpaque<br>    &#125;;<br>	<br>  <span class="hljs-comment">// 先绘制一次可见物体的decallpass，这个是说不用DecalProjector的方式的Decal？ 经过测试这句话即使注释掉也没反应。</span><br>    renderContext.DrawRenderers(cullResults.visibleRenderers, ref drawSettings, filterRenderersSettings);<br>  <br>  <span class="hljs-comment">// 这里再用cmd绘制是直接绘制到屏幕上了，收集相同材质的Decal，使用Instance绘制Decal，Shader是Decal，Dbuffer 有多个渲染目标和深度</span><br>    DecalSystem.instance.RenderIntoDBuffer(cmd);<br>    m_DbufferManager.UnSetHTile(cmd);<br>    m_DbufferManager.SetHTileTexture(cmd);  <span class="hljs-comment">// mask per 8x8 tile used for optimization when looking up dbuffer values</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/6.HDRPDecal/" title="HDRP Decal">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  <article class="article post card animate" itemscope itemtype="http://schema.org/Article">
    <div class="post-block">
      <link itemprop="mainEntityOfPage" href="http://leinlin.github.io/2022/07/09/HDRPsource/8.LitShader/">
      <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
        <meta itemprop="name" content="leinlin">
        <meta itemprop="description" content="">
        <meta itemprop="image" content="/images/avatar.jpg">
      </span>
      <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
        <meta itemprop="name" content="leinlin的小笔记">
      </span>
    </div>
    <header class="post-header">
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link post-title-link-external" href="/2022/07/09/HDRPsource/8.LitShader/" itemprop="url">LitShader参数</a>
      </h1>
      <div class="post-meta">
        
        <span class="post-date">
          <i class="far fa-calendar-plus"></i><span><time title="post-date" itemprop="dateCreated datePublished" datetime="2022-07-09T12:00:14+08:00">2022-07-09 12:00:14</time></span>
        </span>
        
        
        
        <span class="post-meta-divider divider">|</span>
        
        <span class="post-categories">
          
          <i class="far fa-folder-open"></i><span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/HDRPSource/" itemprop="url" rel="index"><span itemprop="name">HDRPSource</span></a></span>
        </span>
        
        
        
        
      </div>
    </header>
    <main class="post-main" itemprop="articleBody">
      
      <h1 id="LitShader参数"><a href="#LitShader参数" class="headerlink" title="LitShader参数"></a>LitShader参数</h1><p><strong>特殊设置：</strong></p>
<p>Alpha CutOff  ：  透明阈值， Alpha值使用BaseColor,a通道，小于这个Alpha值得的位置完全透明。</p>
<p>Use Alpha Test :  是否使用Alpha Test。</p>
<p>Use PIXEL DisPlacement: 是否使用高度图。</p>
<p>Height Min&#x2F;Max Samples  :  高度图最小&#x2F;大采样次数。（决定了效果）</p>
<p>Height Lod Threshold：高度图 Lod，决定效果。</p>
<p><strong>纹理设置：</strong></p>
<p>BaseColor ：基础颜色默认白色，会和BaseColorMap的颜色相乘。</p>
<p>BaseColorMap ：就是漫反射贴图，对应Albedo。</p>
<p>Tiling&#x2F;Offset :决定了所有贴图的便偏移和混合。</p>
<p>NormalMap：切线空间法线贴图。</p>
<p>HeightMAp：当Use PIXEL DisPlacement勾选的时候，这个高度贴图才会生效。使用r通道。</p>
<p>Height Amplitude：高度的强弱。和HeightMap的结果相乘。</p>
<p>MaskMap：分为四个通道，R(Metalness)G(AO)B(Detial)A(Smoothness).</p>
<p>Metallic : 和金属度相乘。</p>
<p>Smothness : 这个值目前无效。（在HDRP中如果使用MaskMap则Smothness无效，这里为了兼容HDRP）</p>
<p>SmoothnessRemapMin ：金属度映射下限</p>
<p>SmoothnessRemapMax ： 金属度映射上限</p>
<p>AORemapMin ：AO映射下限</p>
<p>AORemapMax：AO映射上限</p>
<h1 id="LayeredLit参数"><a href="#LayeredLit参数" class="headerlink" title="LayeredLit参数"></a>LayeredLit参数</h1><p><strong>特殊设置</strong></p>
<p>LayerMaskMap ：混合贴图。</p>
<p>Alpha CutOff：见LitShader，使用的Alpha值来自于所有BaseColor，a通道的混合结果。</p>
<p>Use Alpha Test :  是否使用Alpha Test。</p>
<p>Use PIXEL DisPlacement: 是否使用高度图。高度来自于高度图r通道混合的结果。</p>
<p>Use Mul VERTEX Color Blend： 使用乘法顶点色混合。权重&#x3D;顶点色和LayerMaskMap相乘</p>
<p>Use Add VERTEX Color Blend： 使用加法顶点色混合。权重&#x3D;（顶点色 - 0.5）和和LayerMaskMap相加</p>
<p><strong>注：权重a表示0层，rgb分别表示123层。</strong></p>
<p><strong>Use Mul VERTEX Color Blend&#x2F;Use Add VERTEX Color Blend:选择一个就可以，或者都不选。如果都选则第一个生效。</strong></p>
<p><strong>纹理设置</strong></p>
<p>这部分内容同LitShader一致，只不过最终的值是通过<strong>Mask和顶点色的权重</strong>混合的结果。</p>
<p><strong>纹理层设置</strong></p>
<p>Layer Number Three：使用三层。</p>
<p>Layer Number Four：使用四层。</p>
<p><strong>Layer Number Four&#x2F;Layer Number Three:选择一个就可以</strong></p>
<h1 id="TiledLayeredLit"><a href="#TiledLayeredLit" class="headerlink" title="TiledLayeredLit"></a>TiledLayeredLit</h1><p>和LayeredLit全部一致。只是多了一张纹理和两个参数：</p>
<p>Normal（RG）AO（B) Alpaha(A)：RG通道表示法线的两个通道，B表示AO，A是alpha通道。</p>
<p>注：这个纹理的alpha通道和各层的混合结果的aplpha同时生效。</p>
<p>Main Normal Fractor：各层纹理和这个主纹理的混合程度，0表示完全使用主纹理，1表示完全混合主纹理和细节纹理。</p>
<p>AOFractor：表示主纹理AO所占最终AO比例。0表示不适用主纹理AO。</p>

      
      <p align="right"><a class="morebtn" href="/2022/07/09/HDRPsource/8.LitShader/" title="LitShader参数">阅读全文</a></p>
    </main>
    <footer class="post-footer">
      
    </footer>
  </article>
  
  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fas fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/14/"><i class="fas fa-angle-right" aria-label="下一页"></i></a>
  </nav>
  
  
  

<div class="comments" id="comments">
  
  
  
</div>



  
</div>

          </div>
          
          
          
<aside class="sidebar" id="sidebar" style="background: url(/images/background.png);">
  
  <div class="search">
    <div class="form-group">
      <i class="fas fa-search"></i><input type="search" id="search-input" name="q" results="0" placeholder="搜索" class="form-control"/>
    </div>
  </div>
  <div class="search-result-box" id="search-result"></div>
  
  
<div class="info sidebar-item" id="info">
  
  <img class="author-avatar" src="/images/avatar.jpg" alt="leinlin">
  
  <h1 class="author-name">leinlin</h1>
  <h2 class="author-description"></h2>
  <div class="site-count">
    
    
    
    
    <div class="categories-count count-block">
      <div class="site-count-title">分类</div>
      <div><a href="/categories/">17</a></div>
    </div>
    
    
  </div>
  
  <div class="rss">
    <a class="rss-link button sidebar-item" href="/atom.xml"><i class="fas fa-rss"></i>RSS</a>
  </div>
  
</div>


  <div class="sidebar-sticky">
    
    
    <hr>
    <div class="social-link sidebar-item">
      <div><i class="far fa-address-card"></i>社交链接</p></div>
      <ul>
        
        <li><i class="fab fa-github"></i><a href="https://leinlin.github.com/" target="_blank">GitHub</a></li>
        
      </ul>
    </div>
    
    
  </div>
</aside>


          
        </div>
      </div>
    </main>
    
<footer id="footer" class="footer" style="background: #33363b;">
  <div class="container">
    <div class="back-to-top">
      <button id="back-to-top"><i class="fas fa-angle-double-up" aria-label="回到顶部"></i></button>
    </div>
    <div class="footer-container">
      <div class="footer-left">
        <div class="copyright">
          <span class="author">leinlin</span><span class="year"><i class="far fa-copyright"></i>2022</span>
        </div>
        
        <div class="busuanzi">
          <span id="busuanzi_container_site_pv"><i class="fas fa-eye" aria-label="站点点击量" aria-hidden="false"></i><span id="busuanzi_value_site_pv"></span></span><span id="busuanzi_container_site_uv"><i class="fas fa-user" aria-label="站点用户数" aria-hidden="false"></i><span id="busuanzi_value_site_uv"></span></span><span id="busuanzi_container_page_pv"><i class="far fa-file-alt"></i><span id="busuanzi_value_page_pv" aria-label="页面点击量" aria-hidden="false"></span></span>
        </div>
        
      </div>
      <div class="footer-right">
        <div class="custom-info">
          
          托管于<i class="fab fa-github-alt"></i><a href="https://pages.github.com/" target="_blank">GitHub Pages</a>
          
        </div>
        <div class="powered-by">
          由 <a href="https://hexo.io/" target="_blank">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/AlynxZhou/hexo-theme-aria/" target="_blank">ARIA</a>
        </div>
      </div>
    </div>
  </div>
</footer>


  <script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
